"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = create;

var _regenerator = _interopRequireDefault(require("@babel/runtime/regenerator"));

var _asyncToGenerator2 = _interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));

var _AudioConfig = require("microsoft-cognitiveservices-speech-sdk/distrib/lib/src/sdk/Audio/AudioConfig");

var _microsoftCognitiveservicesSpeechSdk = require("microsoft-cognitiveservices-speech-sdk");

var _createWebSpeechPonyfillFactory = _interopRequireDefault(require("./createWebSpeechPonyfillFactory"));

var _DirectLineSpeech = _interopRequireDefault(require("./DirectLineSpeech"));

var _patchDialogServiceConnectorInline = _interopRequireDefault(require("./patchDialogServiceConnectorInline"));

var _refreshDirectLineToken = _interopRequireDefault(require("./utils/refreshDirectLineToken"));

var _resolveFunctionOrReturnValue = _interopRequireDefault(require("./resolveFunctionOrReturnValue"));

/* eslint complexity: ["error", 33] */
var DIRECT_LINE_TOKEN_RENEWAL_INTERVAL = 900000; // 15 minutes

var TOKEN_RENEWAL_INTERVAL = 120000; // eslint-disable-next-line complexity

function create(_x) {
  return _create.apply(this, arguments);
}

function _create() {
  _create = (0, _asyncToGenerator2.default)( /*#__PURE__*/_regenerator.default.mark(function _callee3(_ref) {
    var audioConfig, audioContext, audioInputDeviceId, enableInternalHTTPSupport, enableTelemetry, fetchCredentials, speechRecognitionEndpointId, _ref$speechRecognitio, speechRecognitionLanguage, speechSynthesisDeploymentId, speechSynthesisOutputFormat, textNormalization, userID, username, _yield$resolveFunctio, authorizationToken, directLineToken, directLineSpeechHostname, region, subscriptionKey, config, dialogServiceConnector, interval, _interval, directLine, webSpeechPonyfillFactory;

    return _regenerator.default.wrap(function _callee3$(_context3) {
      while (1) {
        switch (_context3.prev = _context3.next) {
          case 0:
            audioConfig = _ref.audioConfig, audioContext = _ref.audioContext, audioInputDeviceId = _ref.audioInputDeviceId, enableInternalHTTPSupport = _ref.enableInternalHTTPSupport, enableTelemetry = _ref.enableTelemetry, fetchCredentials = _ref.fetchCredentials, speechRecognitionEndpointId = _ref.speechRecognitionEndpointId, _ref$speechRecognitio = _ref.speechRecognitionLanguage, speechRecognitionLanguage = _ref$speechRecognitio === void 0 ? typeof window !== 'undefined' && typeof window.navigator !== 'undefined' && window.navigator.language || 'en-US' : _ref$speechRecognitio, speechSynthesisDeploymentId = _ref.speechSynthesisDeploymentId, speechSynthesisOutputFormat = _ref.speechSynthesisOutputFormat, textNormalization = _ref.textNormalization, userID = _ref.userID, username = _ref.username;

            if (fetchCredentials) {
              _context3.next = 3;
              break;
            }

            throw new Error('"fetchCredentials" must be specified.');

          case 3:
            _context3.next = 5;
            return (0, _resolveFunctionOrReturnValue.default)(fetchCredentials);

          case 5:
            _yield$resolveFunctio = _context3.sent;
            authorizationToken = _yield$resolveFunctio.authorizationToken;
            directLineToken = _yield$resolveFunctio.directLineToken;
            directLineSpeechHostname = _yield$resolveFunctio.directLineSpeechHostname;
            region = _yield$resolveFunctio.region;
            subscriptionKey = _yield$resolveFunctio.subscriptionKey;

            if (!(!authorizationToken && !subscriptionKey || authorizationToken && subscriptionKey || authorizationToken && typeof authorizationToken !== 'string' || subscriptionKey && typeof subscriptionKey !== 'string' || enableInternalHTTPSupport && !directLineToken)) {
              _context3.next = 13;
              break;
            }

            throw new Error('"fetchCredentials" must return either "authorizationToken" or "subscriptionKey" as a non-empty string only. If enableInternalHTTPSupport is set to true, then it should also return a non-empty "directLineToken"');

          case 13:
            if (typeof enableTelemetry !== 'undefined') {
              console.warn('botframework-directlinespeech: Telemetry options are not yet supported. Please refer to Cognitive Services documentation for details.');
            }

            if (!(directLineSpeechHostname && region || !directLineSpeechHostname && !region)) {
              _context3.next = 16;
              break;
            }

            throw new Error('"fetchCredentials" must return either "directLineSpeechHostname" or "region" and it must not be an empty string.');

          case 16:
            if (!directLineSpeechHostname) {
              _context3.next = 23;
              break;
            }

            if (!(typeof directLineSpeechHostname !== 'string')) {
              _context3.next = 19;
              break;
            }

            throw new Error('"fetchCredentials" must return "directLineSpeechHostname" as a string.');

          case 19:
            if (!enableInternalHTTPSupport) {
              _context3.next = 21;
              break;
            }

            throw new Error('"fetchCredentials" must not return "directLineSpeechHostname" if "enableInternalHTTPSupport" is set.');

          case 21:
            _context3.next = 25;
            break;

          case 23:
            if (!(typeof region !== 'string')) {
              _context3.next = 25;
              break;
            }

            throw new Error('"fetchCredentials" must return "region" as a string.');

          case 25:
            if (audioConfig && audioInputDeviceId) {
              console.warn('botframework-directlinespeech-sdk: Only "audioConfig" or "audioInputDeviceId" can be specified, but not both; ignoring "audioInputDeviceId".');
            } else if (!audioConfig) {
              if (audioInputDeviceId) {
                audioConfig = _AudioConfig.AudioConfig.fromMicrophoneInput(audioInputDeviceId);
              } else {
                audioConfig = _AudioConfig.AudioConfig.fromDefaultMicrophoneInput();
              }
            }

            if (speechRecognitionEndpointId) {
              console.warn('botframework-directlinespeech: Custom Speech is currently not supported; ignoring "speechRecognitionEndpointId".');
            }

            if (speechSynthesisDeploymentId) {
              console.warn('botframework-directlinespeech: Custom Voice is currently not supported; ignoring "speechSynthesisDeploymentId".');
            }

            if (speechSynthesisOutputFormat) {
              console.warn('botframework-directlinespeech: Synthesis output format is currently not supported; ignoring "speechSynthesisOutputFormat".');
            }

            if (textNormalization) {
              console.warn('botframework-directlinespeech: Text normalization is currently not supported; ignoring "textNormalization".');
            }

            if (userID || username) {
              console.warn('botframework-directlinespeech: Custom "userId" and "username" are currently not supported and are ignored.');
            }

            if (directLineSpeechHostname) {
              if (authorizationToken) {
                config = _microsoftCognitiveservicesSpeechSdk.BotFrameworkConfig.fromHost(new URL("wss://".concat(directLineSpeechHostname)));
                config.setProperty(_microsoftCognitiveservicesSpeechSdk.PropertyId.SpeechServiceAuthorization_Token, authorizationToken);
              } else {
                config = _microsoftCognitiveservicesSpeechSdk.BotFrameworkConfig.fromHost(new URL("wss://".concat(directLineSpeechHostname)), subscriptionKey);
              } // TODO: [P1] #3693 In Speech SDK 1.15.0, there is a bug that wrongly construct the endpoint.
              //       https://github.com/microsoft/cognitive-services-speech-sdk-js/issues/315
              //       Remove the following line after the bug is resolved.


              config.setProperty(_microsoftCognitiveservicesSpeechSdk.PropertyId.SpeechServiceConnection_Host, "wss://".concat(directLineSpeechHostname));
            } else {
              if (authorizationToken) {
                config = _microsoftCognitiveservicesSpeechSdk.BotFrameworkConfig.fromAuthorizationToken(authorizationToken, region);
              } else {
                config = _microsoftCognitiveservicesSpeechSdk.BotFrameworkConfig.fromSubscription(subscriptionKey, region);
              } // If internal HTTP support is enabled, switch the endpoint to Direct Line on Direct Line Speech service.


              if (enableInternalHTTPSupport) {
                config.setProperty(_microsoftCognitiveservicesSpeechSdk.PropertyId.SpeechServiceConnection_Endpoint, "wss://".concat(encodeURI(region), ".convai.speech.microsoft.com/directline/api/v1"));
                config.setProperty(_microsoftCognitiveservicesSpeechSdk.PropertyId.Conversation_Agent_Connection_Id, directLineToken);
              }
            } // Supported options can be found in DialogConnectorFactory.js.
            // Set the language used for recognition.


            config.setProperty(_microsoftCognitiveservicesSpeechSdk.PropertyId.SpeechServiceConnection_RecoLanguage, speechRecognitionLanguage); // The following code sets the output format.
            // As advised by the Speech team, this API may be subject to future changes.
            // We are not enabling output format option because it does not send detailed output format to the bot, rendering this option useless.
            // config.setProperty(PropertyId.SpeechServiceResponse_OutputFormatOption, OutputFormat[OutputFormat.Detailed]);
            // Set the user ID for starting the conversation.

            userID && config.setProperty(_microsoftCognitiveservicesSpeechSdk.PropertyId.Conversation_From_Id, userID); // Set Custom Speech and Custom Voice.
            // The following code is copied from C#, and it is not working yet.
            // https://github.com/Azure-Samples/Cognitive-Services-Direct-Line-Speech-Client/blob/master/DLSpeechClient/MainWindow.xaml.cs
            // speechRecognitionEndpointId && config.setServiceProperty('cid', speechRecognitionEndpointId, ServicePropertyChannel.UriQueryParameter);
            // speechSynthesisDeploymentId && config.setProperty(PropertyId.conversation_Custom_Voice_Deployment_Ids, speechSynthesisDeploymentId);

            dialogServiceConnector = (0, _patchDialogServiceConnectorInline.default)(new _microsoftCognitiveservicesSpeechSdk.DialogServiceConnector(config, audioConfig)); // Renew token per interval.

            if (authorizationToken) {
              interval = setInterval( /*#__PURE__*/(0, _asyncToGenerator2.default)( /*#__PURE__*/_regenerator.default.mark(function _callee() {
                var _yield$resolveFunctio2, authorizationToken, nextDirectLineSpeechHostname, nextRegion;

                return _regenerator.default.wrap(function _callee$(_context) {
                  while (1) {
                    switch (_context.prev = _context.next) {
                      case 0:
                        // #2660 If the connector has been disposed, we should stop renewing the token.
                        // TODO: We should use a public implementation if Speech SDK has one related to "privIsDisposed".
                        if (dialogServiceConnector.privIsDisposed) {
                          clearInterval(interval);
                        }

                        _context.next = 3;
                        return (0, _resolveFunctionOrReturnValue.default)(fetchCredentials);

                      case 3:
                        _yield$resolveFunctio2 = _context.sent;
                        authorizationToken = _yield$resolveFunctio2.authorizationToken;
                        nextDirectLineSpeechHostname = _yield$resolveFunctio2.directLineSpeechHostname;
                        nextRegion = _yield$resolveFunctio2.region;

                        if (authorizationToken) {
                          _context.next = 9;
                          break;
                        }

                        return _context.abrupt("return", console.warn('botframework-directlinespeech-sdk: Renew token failed because "fetchCredentials" call returned no authorization token.'));

                      case 9:
                        if (!directLineSpeechHostname) {
                          _context.next = 14;
                          break;
                        }

                        if (!(directLineSpeechHostname !== nextDirectLineSpeechHostname)) {
                          _context.next = 12;
                          break;
                        }

                        return _context.abrupt("return", console.warn('botframework-directlinespeech-sdk: "directLineSpeechHostname" change is not supported for renewed token. Authorization token is not renewed.'));

                      case 12:
                        _context.next = 16;
                        break;

                      case 14:
                        if (!(region !== nextRegion)) {
                          _context.next = 16;
                          break;
                        }

                        return _context.abrupt("return", console.warn('botframework-directlinespeech-sdk: Region change is not supported for renewed token. Authorization token is not renewed.'));

                      case 16:
                        dialogServiceConnector.authorizationToken = authorizationToken; // eslint-disable-line require-atomic-updates

                      case 17:
                      case "end":
                        return _context.stop();
                    }
                  }
                }, _callee);
              })), TOKEN_RENEWAL_INTERVAL);
            } // Renew token per interval.


            if (enableInternalHTTPSupport) {
              _interval = setInterval( /*#__PURE__*/(0, _asyncToGenerator2.default)( /*#__PURE__*/_regenerator.default.mark(function _callee2() {
                var refreshedDirectLineToken;
                return _regenerator.default.wrap(function _callee2$(_context2) {
                  while (1) {
                    switch (_context2.prev = _context2.next) {
                      case 0:
                        // #2660 If the connector has been disposed, we should stop renewing the token.
                        // TODO: We should use a public implementation if Speech SDK has one related to "privIsDisposed".
                        if (dialogServiceConnector.privIsDisposed) {
                          clearInterval(_interval);
                        }

                        _context2.next = 3;
                        return (0, _refreshDirectLineToken.default)(directLineToken);

                      case 3:
                        refreshedDirectLineToken = _context2.sent;

                        if (refreshedDirectLineToken) {
                          _context2.next = 6;
                          break;
                        }

                        return _context2.abrupt("return", console.warn('botframework-directlinespeech-sdk: Renew token failed because call to refresh token Direct Line API did not return a new token.'));

                      case 6:
                        config.setProperty(_microsoftCognitiveservicesSpeechSdk.PropertyId.Conversation_Agent_Connection_Id, refreshedDirectLineToken);
                        dialogServiceConnector.properties.setProperty(_microsoftCognitiveservicesSpeechSdk.PropertyId.Conversation_Agent_Connection_Id, refreshedDirectLineToken);
                        dialogServiceConnector.connect();

                      case 9:
                      case "end":
                        return _context2.stop();
                    }
                  }
                }, _callee2);
              })), DIRECT_LINE_TOKEN_RENEWAL_INTERVAL);
            }

            directLine = new _DirectLineSpeech.default({
              dialogServiceConnector: dialogServiceConnector
            });
            webSpeechPonyfillFactory = (0, _createWebSpeechPonyfillFactory.default)({
              audioContext: audioContext,
              enableTelemetry: enableTelemetry,
              recognizer: dialogServiceConnector,
              textNormalization: textNormalization
            });
            return _context3.abrupt("return", {
              directLine: directLine,
              webSpeechPonyfillFactory: webSpeechPonyfillFactory
            });

          case 40:
          case "end":
            return _context3.stop();
        }
      }
    }, _callee3);
  }));
  return _create.apply(this, arguments);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9jcmVhdGVBZGFwdGVycy5qcyJdLCJuYW1lcyI6WyJESVJFQ1RfTElORV9UT0tFTl9SRU5FV0FMX0lOVEVSVkFMIiwiVE9LRU5fUkVORVdBTF9JTlRFUlZBTCIsImNyZWF0ZSIsImF1ZGlvQ29uZmlnIiwiYXVkaW9Db250ZXh0IiwiYXVkaW9JbnB1dERldmljZUlkIiwiZW5hYmxlSW50ZXJuYWxIVFRQU3VwcG9ydCIsImVuYWJsZVRlbGVtZXRyeSIsImZldGNoQ3JlZGVudGlhbHMiLCJzcGVlY2hSZWNvZ25pdGlvbkVuZHBvaW50SWQiLCJzcGVlY2hSZWNvZ25pdGlvbkxhbmd1YWdlIiwid2luZG93IiwibmF2aWdhdG9yIiwibGFuZ3VhZ2UiLCJzcGVlY2hTeW50aGVzaXNEZXBsb3ltZW50SWQiLCJzcGVlY2hTeW50aGVzaXNPdXRwdXRGb3JtYXQiLCJ0ZXh0Tm9ybWFsaXphdGlvbiIsInVzZXJJRCIsInVzZXJuYW1lIiwiRXJyb3IiLCJhdXRob3JpemF0aW9uVG9rZW4iLCJkaXJlY3RMaW5lVG9rZW4iLCJkaXJlY3RMaW5lU3BlZWNoSG9zdG5hbWUiLCJyZWdpb24iLCJzdWJzY3JpcHRpb25LZXkiLCJjb25zb2xlIiwid2FybiIsIkF1ZGlvQ29uZmlnIiwiZnJvbU1pY3JvcGhvbmVJbnB1dCIsImZyb21EZWZhdWx0TWljcm9waG9uZUlucHV0IiwiY29uZmlnIiwiQm90RnJhbWV3b3JrQ29uZmlnIiwiZnJvbUhvc3QiLCJVUkwiLCJzZXRQcm9wZXJ0eSIsIlByb3BlcnR5SWQiLCJTcGVlY2hTZXJ2aWNlQXV0aG9yaXphdGlvbl9Ub2tlbiIsIlNwZWVjaFNlcnZpY2VDb25uZWN0aW9uX0hvc3QiLCJmcm9tQXV0aG9yaXphdGlvblRva2VuIiwiZnJvbVN1YnNjcmlwdGlvbiIsIlNwZWVjaFNlcnZpY2VDb25uZWN0aW9uX0VuZHBvaW50IiwiZW5jb2RlVVJJIiwiQ29udmVyc2F0aW9uX0FnZW50X0Nvbm5lY3Rpb25fSWQiLCJTcGVlY2hTZXJ2aWNlQ29ubmVjdGlvbl9SZWNvTGFuZ3VhZ2UiLCJDb252ZXJzYXRpb25fRnJvbV9JZCIsImRpYWxvZ1NlcnZpY2VDb25uZWN0b3IiLCJEaWFsb2dTZXJ2aWNlQ29ubmVjdG9yIiwiaW50ZXJ2YWwiLCJzZXRJbnRlcnZhbCIsInByaXZJc0Rpc3Bvc2VkIiwiY2xlYXJJbnRlcnZhbCIsIm5leHREaXJlY3RMaW5lU3BlZWNoSG9zdG5hbWUiLCJuZXh0UmVnaW9uIiwicmVmcmVzaGVkRGlyZWN0TGluZVRva2VuIiwicHJvcGVydGllcyIsImNvbm5lY3QiLCJkaXJlY3RMaW5lIiwiRGlyZWN0TGluZVNwZWVjaCIsIndlYlNwZWVjaFBvbnlmaWxsRmFjdG9yeSIsInJlY29nbml6ZXIiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7QUFFQTs7QUFDQTs7QUFFQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFUQTtBQVdBLElBQU1BLGtDQUFrQyxHQUFHLE1BQTNDLEMsQ0FBbUQ7O0FBQ25ELElBQU1DLHNCQUFzQixHQUFHLE1BQS9CLEMsQ0FFQTs7U0FDOEJDLE07Ozs7O29GQUFmO0FBQUE7O0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFDYkMsWUFBQUEsV0FEYSxRQUNiQSxXQURhLEVBRWJDLFlBRmEsUUFFYkEsWUFGYSxFQUdiQyxrQkFIYSxRQUdiQSxrQkFIYSxFQUliQyx5QkFKYSxRQUliQSx5QkFKYSxFQUtiQyxlQUxhLFFBS2JBLGVBTGEsRUFNYkMsZ0JBTmEsUUFNYkEsZ0JBTmEsRUFPYkMsMkJBUGEsUUFPYkEsMkJBUGEsK0JBUWJDLHlCQVJhLEVBUWJBLHlCQVJhLHNDQVFnQixPQUFPQyxNQUFQLEtBQWtCLFdBQWxCLElBQzNCLE9BQU9BLE1BQU0sQ0FBQ0MsU0FBZCxLQUE0QixXQURELElBRTNCRCxNQUFNLENBQUNDLFNBQVAsQ0FBaUJDLFFBRlMsSUFHMUIsT0FYVywwQkFZYkMsMkJBWmEsUUFZYkEsMkJBWmEsRUFhYkMsMkJBYmEsUUFhYkEsMkJBYmEsRUFjYkMsaUJBZGEsUUFjYkEsaUJBZGEsRUFlYkMsTUFmYSxRQWViQSxNQWZhLEVBZ0JiQyxRQWhCYSxRQWdCYkEsUUFoQmE7O0FBQUEsZ0JBa0JSVixnQkFsQlE7QUFBQTtBQUFBO0FBQUE7O0FBQUEsa0JBbUJMLElBQUlXLEtBQUosQ0FBVSx1Q0FBVixDQW5CSzs7QUFBQTtBQUFBO0FBQUEsbUJBNEJILDJDQUE2QlgsZ0JBQTdCLENBNUJHOztBQUFBO0FBQUE7QUF1QlhZLFlBQUFBLGtCQXZCVyx5QkF1QlhBLGtCQXZCVztBQXdCWEMsWUFBQUEsZUF4QlcseUJBd0JYQSxlQXhCVztBQXlCWEMsWUFBQUEsd0JBekJXLHlCQXlCWEEsd0JBekJXO0FBMEJYQyxZQUFBQSxNQTFCVyx5QkEwQlhBLE1BMUJXO0FBMkJYQyxZQUFBQSxlQTNCVyx5QkEyQlhBLGVBM0JXOztBQUFBLGtCQStCVixDQUFDSixrQkFBRCxJQUF1QixDQUFDSSxlQUF6QixJQUNDSixrQkFBa0IsSUFBSUksZUFEdkIsSUFFQ0osa0JBQWtCLElBQUksT0FBT0Esa0JBQVAsS0FBOEIsUUFGckQsSUFHQ0ksZUFBZSxJQUFJLE9BQU9BLGVBQVAsS0FBMkIsUUFIL0MsSUFJQ2xCLHlCQUF5QixJQUFJLENBQUNlLGVBbkNwQjtBQUFBO0FBQUE7QUFBQTs7QUFBQSxrQkFxQ0wsSUFBSUYsS0FBSixDQUNKLG1OQURJLENBckNLOztBQUFBO0FBMENiLGdCQUFJLE9BQU9aLGVBQVAsS0FBMkIsV0FBL0IsRUFBNEM7QUFDMUNrQixjQUFBQSxPQUFPLENBQUNDLElBQVIsQ0FDRSx1SUFERjtBQUdEOztBQTlDWSxrQkFnRFJKLHdCQUF3QixJQUFJQyxNQUE3QixJQUF5QyxDQUFDRCx3QkFBRCxJQUE2QixDQUFDQyxNQWhEOUQ7QUFBQTtBQUFBO0FBQUE7O0FBQUEsa0JBaURMLElBQUlKLEtBQUosQ0FDSixrSEFESSxDQWpESzs7QUFBQTtBQUFBLGlCQXNEVEcsd0JBdERTO0FBQUE7QUFBQTtBQUFBOztBQUFBLGtCQXVEUCxPQUFPQSx3QkFBUCxLQUFvQyxRQXZEN0I7QUFBQTtBQUFBO0FBQUE7O0FBQUEsa0JBd0RILElBQUlILEtBQUosQ0FBVSx3RUFBVixDQXhERzs7QUFBQTtBQUFBLGlCQTJEUGIseUJBM0RPO0FBQUE7QUFBQTtBQUFBOztBQUFBLGtCQTRESCxJQUFJYSxLQUFKLENBQ0osc0dBREksQ0E1REc7O0FBQUE7QUFBQTtBQUFBOztBQUFBO0FBQUEsa0JBaUVQLE9BQU9JLE1BQVAsS0FBa0IsUUFqRVg7QUFBQTtBQUFBO0FBQUE7O0FBQUEsa0JBa0VILElBQUlKLEtBQUosQ0FBVSxzREFBVixDQWxFRzs7QUFBQTtBQXNFYixnQkFBSWhCLFdBQVcsSUFBSUUsa0JBQW5CLEVBQXVDO0FBQ3JDb0IsY0FBQUEsT0FBTyxDQUFDQyxJQUFSLENBQ0UsOElBREY7QUFHRCxhQUpELE1BSU8sSUFBSSxDQUFDdkIsV0FBTCxFQUFrQjtBQUN2QixrQkFBSUUsa0JBQUosRUFBd0I7QUFDdEJGLGdCQUFBQSxXQUFXLEdBQUd3Qix5QkFBWUMsbUJBQVosQ0FBZ0N2QixrQkFBaEMsQ0FBZDtBQUNELGVBRkQsTUFFTztBQUNMRixnQkFBQUEsV0FBVyxHQUFHd0IseUJBQVlFLDBCQUFaLEVBQWQ7QUFDRDtBQUNGOztBQUVELGdCQUFJcEIsMkJBQUosRUFBaUM7QUFDL0JnQixjQUFBQSxPQUFPLENBQUNDLElBQVIsQ0FDRSxrSEFERjtBQUdEOztBQUVELGdCQUFJWiwyQkFBSixFQUFpQztBQUMvQlcsY0FBQUEsT0FBTyxDQUFDQyxJQUFSLENBQ0UsaUhBREY7QUFHRDs7QUFFRCxnQkFBSVgsMkJBQUosRUFBaUM7QUFDL0JVLGNBQUFBLE9BQU8sQ0FBQ0MsSUFBUixDQUNFLDRIQURGO0FBR0Q7O0FBRUQsZ0JBQUlWLGlCQUFKLEVBQXVCO0FBQ3JCUyxjQUFBQSxPQUFPLENBQUNDLElBQVIsQ0FDRSw2R0FERjtBQUdEOztBQUVELGdCQUFJVCxNQUFNLElBQUlDLFFBQWQsRUFBd0I7QUFDdEJPLGNBQUFBLE9BQU8sQ0FBQ0MsSUFBUixDQUNFLDRHQURGO0FBR0Q7O0FBSUQsZ0JBQUlKLHdCQUFKLEVBQThCO0FBQzVCLGtCQUFJRixrQkFBSixFQUF3QjtBQUN0QlUsZ0JBQUFBLE1BQU0sR0FBR0Msd0RBQW1CQyxRQUFuQixDQUE0QixJQUFJQyxHQUFKLGlCQUFpQlgsd0JBQWpCLEVBQTVCLENBQVQ7QUFFQVEsZ0JBQUFBLE1BQU0sQ0FBQ0ksV0FBUCxDQUFtQkMsZ0RBQVdDLGdDQUE5QixFQUFnRWhCLGtCQUFoRTtBQUNELGVBSkQsTUFJTztBQUNMVSxnQkFBQUEsTUFBTSxHQUFHQyx3REFBbUJDLFFBQW5CLENBQTRCLElBQUlDLEdBQUosaUJBQWlCWCx3QkFBakIsRUFBNUIsRUFBMEVFLGVBQTFFLENBQVQ7QUFDRCxlQVAyQixDQVM1QjtBQUNBO0FBQ0E7OztBQUNBTSxjQUFBQSxNQUFNLENBQUNJLFdBQVAsQ0FBbUJDLGdEQUFXRSw0QkFBOUIsa0JBQXFFZix3QkFBckU7QUFDRCxhQWJELE1BYU87QUFDTCxrQkFBSUYsa0JBQUosRUFBd0I7QUFDdEJVLGdCQUFBQSxNQUFNLEdBQUdDLHdEQUFtQk8sc0JBQW5CLENBQTBDbEIsa0JBQTFDLEVBQThERyxNQUE5RCxDQUFUO0FBQ0QsZUFGRCxNQUVPO0FBQ0xPLGdCQUFBQSxNQUFNLEdBQUdDLHdEQUFtQlEsZ0JBQW5CLENBQW9DZixlQUFwQyxFQUFxREQsTUFBckQsQ0FBVDtBQUNELGVBTEksQ0FPTDs7O0FBQ0Esa0JBQUlqQix5QkFBSixFQUErQjtBQUM3QndCLGdCQUFBQSxNQUFNLENBQUNJLFdBQVAsQ0FDRUMsZ0RBQVdLLGdDQURiLGtCQUVXQyxTQUFTLENBQUNsQixNQUFELENBRnBCO0FBS0FPLGdCQUFBQSxNQUFNLENBQUNJLFdBQVAsQ0FBbUJDLGdEQUFXTyxnQ0FBOUIsRUFBZ0VyQixlQUFoRTtBQUNEO0FBQ0YsYUEvSVksQ0FpSmI7QUFFQTs7O0FBQ0FTLFlBQUFBLE1BQU0sQ0FBQ0ksV0FBUCxDQUFtQkMsZ0RBQVdRLG9DQUE5QixFQUFvRWpDLHlCQUFwRSxFQXBKYSxDQXNKYjtBQUNBO0FBQ0E7QUFDQTtBQUVBOztBQUNBTyxZQUFBQSxNQUFNLElBQUlhLE1BQU0sQ0FBQ0ksV0FBUCxDQUFtQkMsZ0RBQVdTLG9CQUE5QixFQUFvRDNCLE1BQXBELENBQVYsQ0E1SmEsQ0E4SmI7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFTTRCLFlBQUFBLHNCQXBLTyxHQW9La0IsZ0RBQWtDLElBQUlDLDJEQUFKLENBQTJCaEIsTUFBM0IsRUFBbUMzQixXQUFuQyxDQUFsQyxDQXBLbEIsRUFzS2I7O0FBQ0EsZ0JBQUlpQixrQkFBSixFQUF3QjtBQUNoQjJCLGNBQUFBLFFBRGdCLEdBQ0xDLFdBQVcsdUZBQUM7QUFBQTs7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUMzQjtBQUVBO0FBQ0EsNEJBQUlILHNCQUFzQixDQUFDSSxjQUEzQixFQUEyQztBQUN6Q0MsMEJBQUFBLGFBQWEsQ0FBQ0gsUUFBRCxDQUFiO0FBQ0Q7O0FBTjBCO0FBQUEsK0JBWWpCLDJDQUE2QnZDLGdCQUE3QixDQVppQjs7QUFBQTtBQUFBO0FBU3pCWSx3QkFBQUEsa0JBVHlCLDBCQVN6QkEsa0JBVHlCO0FBVUMrQix3QkFBQUEsNEJBVkQsMEJBVXpCN0Isd0JBVnlCO0FBV2pCOEIsd0JBQUFBLFVBWGlCLDBCQVd6QjdCLE1BWHlCOztBQUFBLDRCQWN0Qkgsa0JBZHNCO0FBQUE7QUFBQTtBQUFBOztBQUFBLHlEQWVsQkssT0FBTyxDQUFDQyxJQUFSLENBQ0wsd0hBREssQ0Fma0I7O0FBQUE7QUFBQSw2QkFvQnZCSix3QkFwQnVCO0FBQUE7QUFBQTtBQUFBOztBQUFBLDhCQXFCckJBLHdCQUF3QixLQUFLNkIsNEJBckJSO0FBQUE7QUFBQTtBQUFBOztBQUFBLHlEQXNCaEIxQixPQUFPLENBQUNDLElBQVIsQ0FDTCw4SUFESyxDQXRCZ0I7O0FBQUE7QUFBQTtBQUFBOztBQUFBO0FBQUEsOEJBMkJyQkgsTUFBTSxLQUFLNkIsVUEzQlU7QUFBQTtBQUFBO0FBQUE7O0FBQUEseURBNEJoQjNCLE9BQU8sQ0FBQ0MsSUFBUixDQUNMLDBIQURLLENBNUJnQjs7QUFBQTtBQWtDM0JtQix3QkFBQUEsc0JBQXNCLENBQUN6QixrQkFBdkIsR0FBNENBLGtCQUE1QyxDQWxDMkIsQ0FrQ3FDOztBQWxDckM7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUEsZUFBRCxJQW1DekJuQixzQkFuQ3lCLENBRE47QUFxQ3ZCLGFBNU1ZLENBOE1iOzs7QUFDQSxnQkFBSUsseUJBQUosRUFBK0I7QUFDdkJ5QyxjQUFBQSxTQUR1QixHQUNaQyxXQUFXLHVGQUFDO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUMzQjtBQUVBO0FBQ0EsNEJBQUlILHNCQUFzQixDQUFDSSxjQUEzQixFQUEyQztBQUN6Q0MsMEJBQUFBLGFBQWEsQ0FBQ0gsU0FBRCxDQUFiO0FBQ0Q7O0FBTjBCO0FBQUEsK0JBUVkscUNBQXVCMUIsZUFBdkIsQ0FSWjs7QUFBQTtBQVFyQmdDLHdCQUFBQSx3QkFScUI7O0FBQUEsNEJBVXRCQSx3QkFWc0I7QUFBQTtBQUFBO0FBQUE7O0FBQUEsMERBV2xCNUIsT0FBTyxDQUFDQyxJQUFSLENBQ0wsaUlBREssQ0FYa0I7O0FBQUE7QUFnQjNCSSx3QkFBQUEsTUFBTSxDQUFDSSxXQUFQLENBQW1CQyxnREFBV08sZ0NBQTlCLEVBQWdFVyx3QkFBaEU7QUFFQVIsd0JBQUFBLHNCQUFzQixDQUFDUyxVQUF2QixDQUFrQ3BCLFdBQWxDLENBQ0VDLGdEQUFXTyxnQ0FEYixFQUVFVyx3QkFGRjtBQUlBUix3QkFBQUEsc0JBQXNCLENBQUNVLE9BQXZCOztBQXRCMkI7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUEsZUFBRCxJQXVCekJ2RCxrQ0F2QnlCLENBREM7QUF5QjlCOztBQUVLd0QsWUFBQUEsVUExT08sR0EwT00sSUFBSUMseUJBQUosQ0FBcUI7QUFBRVosY0FBQUEsc0JBQXNCLEVBQXRCQTtBQUFGLGFBQXJCLENBMU9OO0FBNE9QYSxZQUFBQSx3QkE1T08sR0E0T29CLDZDQUErQjtBQUM5RHRELGNBQUFBLFlBQVksRUFBWkEsWUFEOEQ7QUFFOURHLGNBQUFBLGVBQWUsRUFBZkEsZUFGOEQ7QUFHOURvRCxjQUFBQSxVQUFVLEVBQUVkLHNCQUhrRDtBQUk5RDdCLGNBQUFBLGlCQUFpQixFQUFqQkE7QUFKOEQsYUFBL0IsQ0E1T3BCO0FBQUEsOENBbVBOO0FBQ0x3QyxjQUFBQSxVQUFVLEVBQVZBLFVBREs7QUFFTEUsY0FBQUEsd0JBQXdCLEVBQXhCQTtBQUZLLGFBblBNOztBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBLEciLCJzb3VyY2VSb290IjoiZGlyZWN0bGluZXNwZWVjaDovLy8iLCJzb3VyY2VzQ29udGVudCI6WyIvKiBlc2xpbnQgY29tcGxleGl0eTogW1wiZXJyb3JcIiwgMzNdICovXG5cbmltcG9ydCB7IEF1ZGlvQ29uZmlnIH0gZnJvbSAnbWljcm9zb2Z0LWNvZ25pdGl2ZXNlcnZpY2VzLXNwZWVjaC1zZGsvZGlzdHJpYi9saWIvc3JjL3Nkay9BdWRpby9BdWRpb0NvbmZpZyc7XG5pbXBvcnQgeyBCb3RGcmFtZXdvcmtDb25maWcsIERpYWxvZ1NlcnZpY2VDb25uZWN0b3IsIFByb3BlcnR5SWQgfSBmcm9tICdtaWNyb3NvZnQtY29nbml0aXZlc2VydmljZXMtc3BlZWNoLXNkayc7XG5cbmltcG9ydCBjcmVhdGVXZWJTcGVlY2hQb255ZmlsbEZhY3RvcnkgZnJvbSAnLi9jcmVhdGVXZWJTcGVlY2hQb255ZmlsbEZhY3RvcnknO1xuaW1wb3J0IERpcmVjdExpbmVTcGVlY2ggZnJvbSAnLi9EaXJlY3RMaW5lU3BlZWNoJztcbmltcG9ydCBwYXRjaERpYWxvZ1NlcnZpY2VDb25uZWN0b3JJbmxpbmUgZnJvbSAnLi9wYXRjaERpYWxvZ1NlcnZpY2VDb25uZWN0b3JJbmxpbmUnO1xuaW1wb3J0IHJlZnJlc2hEaXJlY3RMaW5lVG9rZW4gZnJvbSAnLi91dGlscy9yZWZyZXNoRGlyZWN0TGluZVRva2VuJztcbmltcG9ydCByZXNvbHZlRnVuY3Rpb25PclJldHVyblZhbHVlIGZyb20gJy4vcmVzb2x2ZUZ1bmN0aW9uT3JSZXR1cm5WYWx1ZSc7XG5cbmNvbnN0IERJUkVDVF9MSU5FX1RPS0VOX1JFTkVXQUxfSU5URVJWQUwgPSA5MDAwMDA7IC8vIDE1IG1pbnV0ZXNcbmNvbnN0IFRPS0VOX1JFTkVXQUxfSU5URVJWQUwgPSAxMjAwMDA7XG5cbi8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBjb21wbGV4aXR5XG5leHBvcnQgZGVmYXVsdCBhc3luYyBmdW5jdGlvbiBjcmVhdGUoe1xuICBhdWRpb0NvbmZpZyxcbiAgYXVkaW9Db250ZXh0LFxuICBhdWRpb0lucHV0RGV2aWNlSWQsXG4gIGVuYWJsZUludGVybmFsSFRUUFN1cHBvcnQsXG4gIGVuYWJsZVRlbGVtZXRyeSxcbiAgZmV0Y2hDcmVkZW50aWFscyxcbiAgc3BlZWNoUmVjb2duaXRpb25FbmRwb2ludElkLFxuICBzcGVlY2hSZWNvZ25pdGlvbkxhbmd1YWdlID0gKHR5cGVvZiB3aW5kb3cgIT09ICd1bmRlZmluZWQnICYmXG4gICAgdHlwZW9mIHdpbmRvdy5uYXZpZ2F0b3IgIT09ICd1bmRlZmluZWQnICYmXG4gICAgd2luZG93Lm5hdmlnYXRvci5sYW5ndWFnZSkgfHxcbiAgICAnZW4tVVMnLFxuICBzcGVlY2hTeW50aGVzaXNEZXBsb3ltZW50SWQsXG4gIHNwZWVjaFN5bnRoZXNpc091dHB1dEZvcm1hdCxcbiAgdGV4dE5vcm1hbGl6YXRpb24sXG4gIHVzZXJJRCxcbiAgdXNlcm5hbWVcbn0pIHtcbiAgaWYgKCFmZXRjaENyZWRlbnRpYWxzKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdcImZldGNoQ3JlZGVudGlhbHNcIiBtdXN0IGJlIHNwZWNpZmllZC4nKTtcbiAgfVxuXG4gIGNvbnN0IHtcbiAgICBhdXRob3JpemF0aW9uVG9rZW4sXG4gICAgZGlyZWN0TGluZVRva2VuLFxuICAgIGRpcmVjdExpbmVTcGVlY2hIb3N0bmFtZSxcbiAgICByZWdpb24sXG4gICAgc3Vic2NyaXB0aW9uS2V5XG4gIH0gPSBhd2FpdCByZXNvbHZlRnVuY3Rpb25PclJldHVyblZhbHVlKGZldGNoQ3JlZGVudGlhbHMpO1xuXG4gIGlmIChcbiAgICAoIWF1dGhvcml6YXRpb25Ub2tlbiAmJiAhc3Vic2NyaXB0aW9uS2V5KSB8fFxuICAgIChhdXRob3JpemF0aW9uVG9rZW4gJiYgc3Vic2NyaXB0aW9uS2V5KSB8fFxuICAgIChhdXRob3JpemF0aW9uVG9rZW4gJiYgdHlwZW9mIGF1dGhvcml6YXRpb25Ub2tlbiAhPT0gJ3N0cmluZycpIHx8XG4gICAgKHN1YnNjcmlwdGlvbktleSAmJiB0eXBlb2Ygc3Vic2NyaXB0aW9uS2V5ICE9PSAnc3RyaW5nJykgfHxcbiAgICAoZW5hYmxlSW50ZXJuYWxIVFRQU3VwcG9ydCAmJiAhZGlyZWN0TGluZVRva2VuKVxuICApIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAnXCJmZXRjaENyZWRlbnRpYWxzXCIgbXVzdCByZXR1cm4gZWl0aGVyIFwiYXV0aG9yaXphdGlvblRva2VuXCIgb3IgXCJzdWJzY3JpcHRpb25LZXlcIiBhcyBhIG5vbi1lbXB0eSBzdHJpbmcgb25seS4gSWYgZW5hYmxlSW50ZXJuYWxIVFRQU3VwcG9ydCBpcyBzZXQgdG8gdHJ1ZSwgdGhlbiBpdCBzaG91bGQgYWxzbyByZXR1cm4gYSBub24tZW1wdHkgXCJkaXJlY3RMaW5lVG9rZW5cIidcbiAgICApO1xuICB9XG5cbiAgaWYgKHR5cGVvZiBlbmFibGVUZWxlbWV0cnkgIT09ICd1bmRlZmluZWQnKSB7XG4gICAgY29uc29sZS53YXJuKFxuICAgICAgJ2JvdGZyYW1ld29yay1kaXJlY3RsaW5lc3BlZWNoOiBUZWxlbWV0cnkgb3B0aW9ucyBhcmUgbm90IHlldCBzdXBwb3J0ZWQuIFBsZWFzZSByZWZlciB0byBDb2duaXRpdmUgU2VydmljZXMgZG9jdW1lbnRhdGlvbiBmb3IgZGV0YWlscy4nXG4gICAgKTtcbiAgfVxuXG4gIGlmICgoZGlyZWN0TGluZVNwZWVjaEhvc3RuYW1lICYmIHJlZ2lvbikgfHwgKCFkaXJlY3RMaW5lU3BlZWNoSG9zdG5hbWUgJiYgIXJlZ2lvbikpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAnXCJmZXRjaENyZWRlbnRpYWxzXCIgbXVzdCByZXR1cm4gZWl0aGVyIFwiZGlyZWN0TGluZVNwZWVjaEhvc3RuYW1lXCIgb3IgXCJyZWdpb25cIiBhbmQgaXQgbXVzdCBub3QgYmUgYW4gZW1wdHkgc3RyaW5nLidcbiAgICApO1xuICB9XG5cbiAgaWYgKGRpcmVjdExpbmVTcGVlY2hIb3N0bmFtZSkge1xuICAgIGlmICh0eXBlb2YgZGlyZWN0TGluZVNwZWVjaEhvc3RuYW1lICE9PSAnc3RyaW5nJykge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdcImZldGNoQ3JlZGVudGlhbHNcIiBtdXN0IHJldHVybiBcImRpcmVjdExpbmVTcGVlY2hIb3N0bmFtZVwiIGFzIGEgc3RyaW5nLicpO1xuICAgIH1cblxuICAgIGlmIChlbmFibGVJbnRlcm5hbEhUVFBTdXBwb3J0KSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICdcImZldGNoQ3JlZGVudGlhbHNcIiBtdXN0IG5vdCByZXR1cm4gXCJkaXJlY3RMaW5lU3BlZWNoSG9zdG5hbWVcIiBpZiBcImVuYWJsZUludGVybmFsSFRUUFN1cHBvcnRcIiBpcyBzZXQuJ1xuICAgICAgKTtcbiAgICB9XG4gIH0gZWxzZSB7XG4gICAgaWYgKHR5cGVvZiByZWdpb24gIT09ICdzdHJpbmcnKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ1wiZmV0Y2hDcmVkZW50aWFsc1wiIG11c3QgcmV0dXJuIFwicmVnaW9uXCIgYXMgYSBzdHJpbmcuJyk7XG4gICAgfVxuICB9XG5cbiAgaWYgKGF1ZGlvQ29uZmlnICYmIGF1ZGlvSW5wdXREZXZpY2VJZCkge1xuICAgIGNvbnNvbGUud2FybihcbiAgICAgICdib3RmcmFtZXdvcmstZGlyZWN0bGluZXNwZWVjaC1zZGs6IE9ubHkgXCJhdWRpb0NvbmZpZ1wiIG9yIFwiYXVkaW9JbnB1dERldmljZUlkXCIgY2FuIGJlIHNwZWNpZmllZCwgYnV0IG5vdCBib3RoOyBpZ25vcmluZyBcImF1ZGlvSW5wdXREZXZpY2VJZFwiLidcbiAgICApO1xuICB9IGVsc2UgaWYgKCFhdWRpb0NvbmZpZykge1xuICAgIGlmIChhdWRpb0lucHV0RGV2aWNlSWQpIHtcbiAgICAgIGF1ZGlvQ29uZmlnID0gQXVkaW9Db25maWcuZnJvbU1pY3JvcGhvbmVJbnB1dChhdWRpb0lucHV0RGV2aWNlSWQpO1xuICAgIH0gZWxzZSB7XG4gICAgICBhdWRpb0NvbmZpZyA9IEF1ZGlvQ29uZmlnLmZyb21EZWZhdWx0TWljcm9waG9uZUlucHV0KCk7XG4gICAgfVxuICB9XG5cbiAgaWYgKHNwZWVjaFJlY29nbml0aW9uRW5kcG9pbnRJZCkge1xuICAgIGNvbnNvbGUud2FybihcbiAgICAgICdib3RmcmFtZXdvcmstZGlyZWN0bGluZXNwZWVjaDogQ3VzdG9tIFNwZWVjaCBpcyBjdXJyZW50bHkgbm90IHN1cHBvcnRlZDsgaWdub3JpbmcgXCJzcGVlY2hSZWNvZ25pdGlvbkVuZHBvaW50SWRcIi4nXG4gICAgKTtcbiAgfVxuXG4gIGlmIChzcGVlY2hTeW50aGVzaXNEZXBsb3ltZW50SWQpIHtcbiAgICBjb25zb2xlLndhcm4oXG4gICAgICAnYm90ZnJhbWV3b3JrLWRpcmVjdGxpbmVzcGVlY2g6IEN1c3RvbSBWb2ljZSBpcyBjdXJyZW50bHkgbm90IHN1cHBvcnRlZDsgaWdub3JpbmcgXCJzcGVlY2hTeW50aGVzaXNEZXBsb3ltZW50SWRcIi4nXG4gICAgKTtcbiAgfVxuXG4gIGlmIChzcGVlY2hTeW50aGVzaXNPdXRwdXRGb3JtYXQpIHtcbiAgICBjb25zb2xlLndhcm4oXG4gICAgICAnYm90ZnJhbWV3b3JrLWRpcmVjdGxpbmVzcGVlY2g6IFN5bnRoZXNpcyBvdXRwdXQgZm9ybWF0IGlzIGN1cnJlbnRseSBub3Qgc3VwcG9ydGVkOyBpZ25vcmluZyBcInNwZWVjaFN5bnRoZXNpc091dHB1dEZvcm1hdFwiLidcbiAgICApO1xuICB9XG5cbiAgaWYgKHRleHROb3JtYWxpemF0aW9uKSB7XG4gICAgY29uc29sZS53YXJuKFxuICAgICAgJ2JvdGZyYW1ld29yay1kaXJlY3RsaW5lc3BlZWNoOiBUZXh0IG5vcm1hbGl6YXRpb24gaXMgY3VycmVudGx5IG5vdCBzdXBwb3J0ZWQ7IGlnbm9yaW5nIFwidGV4dE5vcm1hbGl6YXRpb25cIi4nXG4gICAgKTtcbiAgfVxuXG4gIGlmICh1c2VySUQgfHwgdXNlcm5hbWUpIHtcbiAgICBjb25zb2xlLndhcm4oXG4gICAgICAnYm90ZnJhbWV3b3JrLWRpcmVjdGxpbmVzcGVlY2g6IEN1c3RvbSBcInVzZXJJZFwiIGFuZCBcInVzZXJuYW1lXCIgYXJlIGN1cnJlbnRseSBub3Qgc3VwcG9ydGVkIGFuZCBhcmUgaWdub3JlZC4nXG4gICAgKTtcbiAgfVxuXG4gIGxldCBjb25maWc7XG5cbiAgaWYgKGRpcmVjdExpbmVTcGVlY2hIb3N0bmFtZSkge1xuICAgIGlmIChhdXRob3JpemF0aW9uVG9rZW4pIHtcbiAgICAgIGNvbmZpZyA9IEJvdEZyYW1ld29ya0NvbmZpZy5mcm9tSG9zdChuZXcgVVJMKGB3c3M6Ly8ke2RpcmVjdExpbmVTcGVlY2hIb3N0bmFtZX1gKSk7XG5cbiAgICAgIGNvbmZpZy5zZXRQcm9wZXJ0eShQcm9wZXJ0eUlkLlNwZWVjaFNlcnZpY2VBdXRob3JpemF0aW9uX1Rva2VuLCBhdXRob3JpemF0aW9uVG9rZW4pO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25maWcgPSBCb3RGcmFtZXdvcmtDb25maWcuZnJvbUhvc3QobmV3IFVSTChgd3NzOi8vJHtkaXJlY3RMaW5lU3BlZWNoSG9zdG5hbWV9YCksIHN1YnNjcmlwdGlvbktleSk7XG4gICAgfVxuXG4gICAgLy8gVE9ETzogW1AxXSAjMzY5MyBJbiBTcGVlY2ggU0RLIDEuMTUuMCwgdGhlcmUgaXMgYSBidWcgdGhhdCB3cm9uZ2x5IGNvbnN0cnVjdCB0aGUgZW5kcG9pbnQuXG4gICAgLy8gICAgICAgaHR0cHM6Ly9naXRodWIuY29tL21pY3Jvc29mdC9jb2duaXRpdmUtc2VydmljZXMtc3BlZWNoLXNkay1qcy9pc3N1ZXMvMzE1XG4gICAgLy8gICAgICAgUmVtb3ZlIHRoZSBmb2xsb3dpbmcgbGluZSBhZnRlciB0aGUgYnVnIGlzIHJlc29sdmVkLlxuICAgIGNvbmZpZy5zZXRQcm9wZXJ0eShQcm9wZXJ0eUlkLlNwZWVjaFNlcnZpY2VDb25uZWN0aW9uX0hvc3QsIGB3c3M6Ly8ke2RpcmVjdExpbmVTcGVlY2hIb3N0bmFtZX1gKTtcbiAgfSBlbHNlIHtcbiAgICBpZiAoYXV0aG9yaXphdGlvblRva2VuKSB7XG4gICAgICBjb25maWcgPSBCb3RGcmFtZXdvcmtDb25maWcuZnJvbUF1dGhvcml6YXRpb25Ub2tlbihhdXRob3JpemF0aW9uVG9rZW4sIHJlZ2lvbik7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbmZpZyA9IEJvdEZyYW1ld29ya0NvbmZpZy5mcm9tU3Vic2NyaXB0aW9uKHN1YnNjcmlwdGlvbktleSwgcmVnaW9uKTtcbiAgICB9XG5cbiAgICAvLyBJZiBpbnRlcm5hbCBIVFRQIHN1cHBvcnQgaXMgZW5hYmxlZCwgc3dpdGNoIHRoZSBlbmRwb2ludCB0byBEaXJlY3QgTGluZSBvbiBEaXJlY3QgTGluZSBTcGVlY2ggc2VydmljZS5cbiAgICBpZiAoZW5hYmxlSW50ZXJuYWxIVFRQU3VwcG9ydCkge1xuICAgICAgY29uZmlnLnNldFByb3BlcnR5KFxuICAgICAgICBQcm9wZXJ0eUlkLlNwZWVjaFNlcnZpY2VDb25uZWN0aW9uX0VuZHBvaW50LFxuICAgICAgICBgd3NzOi8vJHtlbmNvZGVVUkkocmVnaW9uKX0uY29udmFpLnNwZWVjaC5taWNyb3NvZnQuY29tL2RpcmVjdGxpbmUvYXBpL3YxYFxuICAgICAgKTtcblxuICAgICAgY29uZmlnLnNldFByb3BlcnR5KFByb3BlcnR5SWQuQ29udmVyc2F0aW9uX0FnZW50X0Nvbm5lY3Rpb25fSWQsIGRpcmVjdExpbmVUb2tlbik7XG4gICAgfVxuICB9XG5cbiAgLy8gU3VwcG9ydGVkIG9wdGlvbnMgY2FuIGJlIGZvdW5kIGluIERpYWxvZ0Nvbm5lY3RvckZhY3RvcnkuanMuXG5cbiAgLy8gU2V0IHRoZSBsYW5ndWFnZSB1c2VkIGZvciByZWNvZ25pdGlvbi5cbiAgY29uZmlnLnNldFByb3BlcnR5KFByb3BlcnR5SWQuU3BlZWNoU2VydmljZUNvbm5lY3Rpb25fUmVjb0xhbmd1YWdlLCBzcGVlY2hSZWNvZ25pdGlvbkxhbmd1YWdlKTtcblxuICAvLyBUaGUgZm9sbG93aW5nIGNvZGUgc2V0cyB0aGUgb3V0cHV0IGZvcm1hdC5cbiAgLy8gQXMgYWR2aXNlZCBieSB0aGUgU3BlZWNoIHRlYW0sIHRoaXMgQVBJIG1heSBiZSBzdWJqZWN0IHRvIGZ1dHVyZSBjaGFuZ2VzLlxuICAvLyBXZSBhcmUgbm90IGVuYWJsaW5nIG91dHB1dCBmb3JtYXQgb3B0aW9uIGJlY2F1c2UgaXQgZG9lcyBub3Qgc2VuZCBkZXRhaWxlZCBvdXRwdXQgZm9ybWF0IHRvIHRoZSBib3QsIHJlbmRlcmluZyB0aGlzIG9wdGlvbiB1c2VsZXNzLlxuICAvLyBjb25maWcuc2V0UHJvcGVydHkoUHJvcGVydHlJZC5TcGVlY2hTZXJ2aWNlUmVzcG9uc2VfT3V0cHV0Rm9ybWF0T3B0aW9uLCBPdXRwdXRGb3JtYXRbT3V0cHV0Rm9ybWF0LkRldGFpbGVkXSk7XG5cbiAgLy8gU2V0IHRoZSB1c2VyIElEIGZvciBzdGFydGluZyB0aGUgY29udmVyc2F0aW9uLlxuICB1c2VySUQgJiYgY29uZmlnLnNldFByb3BlcnR5KFByb3BlcnR5SWQuQ29udmVyc2F0aW9uX0Zyb21fSWQsIHVzZXJJRCk7XG5cbiAgLy8gU2V0IEN1c3RvbSBTcGVlY2ggYW5kIEN1c3RvbSBWb2ljZS5cbiAgLy8gVGhlIGZvbGxvd2luZyBjb2RlIGlzIGNvcGllZCBmcm9tIEMjLCBhbmQgaXQgaXMgbm90IHdvcmtpbmcgeWV0LlxuICAvLyBodHRwczovL2dpdGh1Yi5jb20vQXp1cmUtU2FtcGxlcy9Db2duaXRpdmUtU2VydmljZXMtRGlyZWN0LUxpbmUtU3BlZWNoLUNsaWVudC9ibG9iL21hc3Rlci9ETFNwZWVjaENsaWVudC9NYWluV2luZG93LnhhbWwuY3NcbiAgLy8gc3BlZWNoUmVjb2duaXRpb25FbmRwb2ludElkICYmIGNvbmZpZy5zZXRTZXJ2aWNlUHJvcGVydHkoJ2NpZCcsIHNwZWVjaFJlY29nbml0aW9uRW5kcG9pbnRJZCwgU2VydmljZVByb3BlcnR5Q2hhbm5lbC5VcmlRdWVyeVBhcmFtZXRlcik7XG4gIC8vIHNwZWVjaFN5bnRoZXNpc0RlcGxveW1lbnRJZCAmJiBjb25maWcuc2V0UHJvcGVydHkoUHJvcGVydHlJZC5jb252ZXJzYXRpb25fQ3VzdG9tX1ZvaWNlX0RlcGxveW1lbnRfSWRzLCBzcGVlY2hTeW50aGVzaXNEZXBsb3ltZW50SWQpO1xuXG4gIGNvbnN0IGRpYWxvZ1NlcnZpY2VDb25uZWN0b3IgPSBwYXRjaERpYWxvZ1NlcnZpY2VDb25uZWN0b3JJbmxpbmUobmV3IERpYWxvZ1NlcnZpY2VDb25uZWN0b3IoY29uZmlnLCBhdWRpb0NvbmZpZykpO1xuXG4gIC8vIFJlbmV3IHRva2VuIHBlciBpbnRlcnZhbC5cbiAgaWYgKGF1dGhvcml6YXRpb25Ub2tlbikge1xuICAgIGNvbnN0IGludGVydmFsID0gc2V0SW50ZXJ2YWwoYXN5bmMgKCkgPT4ge1xuICAgICAgLy8gIzI2NjAgSWYgdGhlIGNvbm5lY3RvciBoYXMgYmVlbiBkaXNwb3NlZCwgd2Ugc2hvdWxkIHN0b3AgcmVuZXdpbmcgdGhlIHRva2VuLlxuXG4gICAgICAvLyBUT0RPOiBXZSBzaG91bGQgdXNlIGEgcHVibGljIGltcGxlbWVudGF0aW9uIGlmIFNwZWVjaCBTREsgaGFzIG9uZSByZWxhdGVkIHRvIFwicHJpdklzRGlzcG9zZWRcIi5cbiAgICAgIGlmIChkaWFsb2dTZXJ2aWNlQ29ubmVjdG9yLnByaXZJc0Rpc3Bvc2VkKSB7XG4gICAgICAgIGNsZWFySW50ZXJ2YWwoaW50ZXJ2YWwpO1xuICAgICAgfVxuXG4gICAgICBjb25zdCB7XG4gICAgICAgIGF1dGhvcml6YXRpb25Ub2tlbixcbiAgICAgICAgZGlyZWN0TGluZVNwZWVjaEhvc3RuYW1lOiBuZXh0RGlyZWN0TGluZVNwZWVjaEhvc3RuYW1lLFxuICAgICAgICByZWdpb246IG5leHRSZWdpb25cbiAgICAgIH0gPSBhd2FpdCByZXNvbHZlRnVuY3Rpb25PclJldHVyblZhbHVlKGZldGNoQ3JlZGVudGlhbHMpO1xuXG4gICAgICBpZiAoIWF1dGhvcml6YXRpb25Ub2tlbikge1xuICAgICAgICByZXR1cm4gY29uc29sZS53YXJuKFxuICAgICAgICAgICdib3RmcmFtZXdvcmstZGlyZWN0bGluZXNwZWVjaC1zZGs6IFJlbmV3IHRva2VuIGZhaWxlZCBiZWNhdXNlIFwiZmV0Y2hDcmVkZW50aWFsc1wiIGNhbGwgcmV0dXJuZWQgbm8gYXV0aG9yaXphdGlvbiB0b2tlbi4nXG4gICAgICAgICk7XG4gICAgICB9XG5cbiAgICAgIGlmIChkaXJlY3RMaW5lU3BlZWNoSG9zdG5hbWUpIHtcbiAgICAgICAgaWYgKGRpcmVjdExpbmVTcGVlY2hIb3N0bmFtZSAhPT0gbmV4dERpcmVjdExpbmVTcGVlY2hIb3N0bmFtZSkge1xuICAgICAgICAgIHJldHVybiBjb25zb2xlLndhcm4oXG4gICAgICAgICAgICAnYm90ZnJhbWV3b3JrLWRpcmVjdGxpbmVzcGVlY2gtc2RrOiBcImRpcmVjdExpbmVTcGVlY2hIb3N0bmFtZVwiIGNoYW5nZSBpcyBub3Qgc3VwcG9ydGVkIGZvciByZW5ld2VkIHRva2VuLiBBdXRob3JpemF0aW9uIHRva2VuIGlzIG5vdCByZW5ld2VkLidcbiAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBpZiAocmVnaW9uICE9PSBuZXh0UmVnaW9uKSB7XG4gICAgICAgICAgcmV0dXJuIGNvbnNvbGUud2FybihcbiAgICAgICAgICAgICdib3RmcmFtZXdvcmstZGlyZWN0bGluZXNwZWVjaC1zZGs6IFJlZ2lvbiBjaGFuZ2UgaXMgbm90IHN1cHBvcnRlZCBmb3IgcmVuZXdlZCB0b2tlbi4gQXV0aG9yaXphdGlvbiB0b2tlbiBpcyBub3QgcmVuZXdlZC4nXG4gICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICBkaWFsb2dTZXJ2aWNlQ29ubmVjdG9yLmF1dGhvcml6YXRpb25Ub2tlbiA9IGF1dGhvcml6YXRpb25Ub2tlbjsgLy8gZXNsaW50LWRpc2FibGUtbGluZSByZXF1aXJlLWF0b21pYy11cGRhdGVzXG4gICAgfSwgVE9LRU5fUkVORVdBTF9JTlRFUlZBTCk7XG4gIH1cblxuICAvLyBSZW5ldyB0b2tlbiBwZXIgaW50ZXJ2YWwuXG4gIGlmIChlbmFibGVJbnRlcm5hbEhUVFBTdXBwb3J0KSB7XG4gICAgY29uc3QgaW50ZXJ2YWwgPSBzZXRJbnRlcnZhbChhc3luYyAoKSA9PiB7XG4gICAgICAvLyAjMjY2MCBJZiB0aGUgY29ubmVjdG9yIGhhcyBiZWVuIGRpc3Bvc2VkLCB3ZSBzaG91bGQgc3RvcCByZW5ld2luZyB0aGUgdG9rZW4uXG5cbiAgICAgIC8vIFRPRE86IFdlIHNob3VsZCB1c2UgYSBwdWJsaWMgaW1wbGVtZW50YXRpb24gaWYgU3BlZWNoIFNESyBoYXMgb25lIHJlbGF0ZWQgdG8gXCJwcml2SXNEaXNwb3NlZFwiLlxuICAgICAgaWYgKGRpYWxvZ1NlcnZpY2VDb25uZWN0b3IucHJpdklzRGlzcG9zZWQpIHtcbiAgICAgICAgY2xlYXJJbnRlcnZhbChpbnRlcnZhbCk7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IHJlZnJlc2hlZERpcmVjdExpbmVUb2tlbiA9IGF3YWl0IHJlZnJlc2hEaXJlY3RMaW5lVG9rZW4oZGlyZWN0TGluZVRva2VuKTtcblxuICAgICAgaWYgKCFyZWZyZXNoZWREaXJlY3RMaW5lVG9rZW4pIHtcbiAgICAgICAgcmV0dXJuIGNvbnNvbGUud2FybihcbiAgICAgICAgICAnYm90ZnJhbWV3b3JrLWRpcmVjdGxpbmVzcGVlY2gtc2RrOiBSZW5ldyB0b2tlbiBmYWlsZWQgYmVjYXVzZSBjYWxsIHRvIHJlZnJlc2ggdG9rZW4gRGlyZWN0IExpbmUgQVBJIGRpZCBub3QgcmV0dXJuIGEgbmV3IHRva2VuLidcbiAgICAgICAgKTtcbiAgICAgIH1cblxuICAgICAgY29uZmlnLnNldFByb3BlcnR5KFByb3BlcnR5SWQuQ29udmVyc2F0aW9uX0FnZW50X0Nvbm5lY3Rpb25fSWQsIHJlZnJlc2hlZERpcmVjdExpbmVUb2tlbik7XG5cbiAgICAgIGRpYWxvZ1NlcnZpY2VDb25uZWN0b3IucHJvcGVydGllcy5zZXRQcm9wZXJ0eShcbiAgICAgICAgUHJvcGVydHlJZC5Db252ZXJzYXRpb25fQWdlbnRfQ29ubmVjdGlvbl9JZCxcbiAgICAgICAgcmVmcmVzaGVkRGlyZWN0TGluZVRva2VuXG4gICAgICApO1xuICAgICAgZGlhbG9nU2VydmljZUNvbm5lY3Rvci5jb25uZWN0KCk7XG4gICAgfSwgRElSRUNUX0xJTkVfVE9LRU5fUkVORVdBTF9JTlRFUlZBTCk7XG4gIH1cblxuICBjb25zdCBkaXJlY3RMaW5lID0gbmV3IERpcmVjdExpbmVTcGVlY2goeyBkaWFsb2dTZXJ2aWNlQ29ubmVjdG9yIH0pO1xuXG4gIGNvbnN0IHdlYlNwZWVjaFBvbnlmaWxsRmFjdG9yeSA9IGNyZWF0ZVdlYlNwZWVjaFBvbnlmaWxsRmFjdG9yeSh7XG4gICAgYXVkaW9Db250ZXh0LFxuICAgIGVuYWJsZVRlbGVtZXRyeSxcbiAgICByZWNvZ25pemVyOiBkaWFsb2dTZXJ2aWNlQ29ubmVjdG9yLFxuICAgIHRleHROb3JtYWxpemF0aW9uXG4gIH0pO1xuXG4gIHJldHVybiB7XG4gICAgZGlyZWN0TGluZSxcbiAgICB3ZWJTcGVlY2hQb255ZmlsbEZhY3RvcnlcbiAgfTtcbn1cbiJdfQ==