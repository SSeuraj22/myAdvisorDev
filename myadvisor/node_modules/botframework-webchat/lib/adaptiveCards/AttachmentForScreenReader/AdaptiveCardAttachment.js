"use strict";

var _interopRequireWildcard = require("@babel/runtime/helpers/interopRequireWildcard");

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _slicedToArray2 = _interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));

var _botframeworkWebchatComponent = require("botframework-webchat-component");

var _propTypes = _interopRequireDefault(require("prop-types"));

var _react = _interopRequireWildcard(require("react"));

var _useAdaptiveCardsPackage = _interopRequireDefault(require("../hooks/useAdaptiveCardsPackage"));

var _useParseAdaptiveCardJSON = _interopRequireDefault(require("../hooks/internal/useParseAdaptiveCardJSON"));

var _useUniqueId = _interopRequireDefault(require("../hooks/internal/useUniqueId"));

/* eslint-disable react/no-array-index-key */

/* eslint-disable react/forbid-dom-props */
var useLocalizer = _botframeworkWebchatComponent.hooks.useLocalizer; // Perform a depth-first search of the Adaptive Card tree.

function walkAllItems(node, fn) {
  fn(node);

  if (node.getItemAt && node.getItemCount) {
    for (var count = node.getItemCount(), index = 0; index < count; index++) {
      walkAllItems(node.getItemAt(index), fn);
    }
  }

  if (node.getActionAt && node.getActionCount) {
    for (var _count = node.getActionCount(), _index = 0; _index < _count; _index++) {
      fn(node.getActionAt(_index));
    }
  }
}

var AdaptiveCardChoiceSetInput = function AdaptiveCardChoiceSetInput(_ref) {
  var _ref$input = _ref.input,
      choices = _ref$input.choices,
      defaultValue = _ref$input.defaultValue;
  var labelId = (0, _useUniqueId.default)('webchat__id');
  var defaultChoice = choices.find(function (_ref2) {
    var value = _ref2.value;
    return defaultValue === value || !defaultValue && !value;
  });
  return /*#__PURE__*/_react.default.createElement("div", null, /*#__PURE__*/_react.default.createElement("select", {
    "aria-labelledby": defaultChoice ? labelId : undefined,
    defaultValue: defaultValue,
    tabIndex: -1
  }, choices.map(function (choice) {
    return /*#__PURE__*/_react.default.createElement("option", {
      id: choice === defaultChoice ? labelId : undefined,
      key: choice.value,
      value: choice.value
    }, choice.title);
  })));
};

AdaptiveCardChoiceSetInput.propTypes = {
  input: _propTypes.default.shape({
    choices: _propTypes.default.arrayOf(_propTypes.default.shape({
      title: _propTypes.default.string,
      value: _propTypes.default.any
    })),
    defaultValue: _propTypes.default.any,
    value: _propTypes.default.any
  }).isRequired
};

var AdaptiveCardAttachment = function AdaptiveCardAttachment(_ref3) {
  var content = _ref3.content;
  var labelId = (0, _useUniqueId.default)('webchat__id');
  var localize = useLocalizer();
  var parseAdaptiveCardJSON = (0, _useParseAdaptiveCardJSON.default)();

  var _useAdaptiveCardsPack = (0, _useAdaptiveCardsPackage.default)(),
      _useAdaptiveCardsPack2 = (0, _slicedToArray2.default)(_useAdaptiveCardsPack, 1),
      _useAdaptiveCardsPack3 = _useAdaptiveCardsPack2[0],
      ChoiceSetInput = _useAdaptiveCardsPack3.ChoiceSetInput,
      DateInput = _useAdaptiveCardsPack3.DateInput,
      NumberInput = _useAdaptiveCardsPack3.NumberInput,
      OpenUrlAction = _useAdaptiveCardsPack3.OpenUrlAction,
      ShowCardAction = _useAdaptiveCardsPack3.ShowCardAction,
      SubmitAction = _useAdaptiveCardsPack3.SubmitAction,
      TextInput = _useAdaptiveCardsPack3.TextInput,
      TimeInput = _useAdaptiveCardsPack3.TimeInput,
      ToggleInput = _useAdaptiveCardsPack3.ToggleInput;

  var card = (0, _react.useMemo)(function () {
    return parseAdaptiveCardJSON(content, {
      ignoreErrors: true
    });
  }, [content, parseAdaptiveCardJSON]);
  var inputs = (0, _react.useMemo)(function () {
    var inputs = [];
    walkAllItems(card, function (node) {
      if (node instanceof ChoiceSetInput || node instanceof DateInput || node instanceof NumberInput || node instanceof OpenUrlAction || node instanceof ShowCardAction || node instanceof SubmitAction || node instanceof TextInput || node instanceof TimeInput || node instanceof ToggleInput) {
        inputs.push(node);
      }
    });
    return inputs;
  }, [card, ChoiceSetInput, DateInput, NumberInput, OpenUrlAction, ShowCardAction, SubmitAction, TextInput, TimeInput, ToggleInput]);
  var cardLabel = localize('ATTACHMENT_CARD', card.speak || '', '', '');
  return /*#__PURE__*/_react.default.createElement("article", {
    "aria-labelledby": labelId
  }, /*#__PURE__*/_react.default.createElement("div", {
    id: labelId
  }, cardLabel), inputs.map(function (input, index) {
    return input instanceof ChoiceSetInput ? /*#__PURE__*/_react.default.createElement(AdaptiveCardChoiceSetInput, {
      input: input,
      key: index
    }) : input instanceof DateInput ? /*#__PURE__*/_react.default.createElement("div", {
      key: index
    }, /*#__PURE__*/_react.default.createElement("input", {
      placeholder: input.placeholder,
      tabIndex: -1,
      type: "date"
    })) : input instanceof NumberInput ? /*#__PURE__*/_react.default.createElement("div", {
      key: index
    }, /*#__PURE__*/_react.default.createElement("input", {
      placeholder: input.placeholder,
      tabIndex: -1,
      type: "number"
    })) : input instanceof OpenUrlAction || input instanceof ShowCardAction || input instanceof SubmitAction ? /*#__PURE__*/_react.default.createElement("div", {
      key: index
    }, /*#__PURE__*/_react.default.createElement("button", {
      tabIndex: -1,
      type: "button"
    }, input.title)) : input instanceof TextInput ? /*#__PURE__*/_react.default.createElement("div", {
      key: index
    }, /*#__PURE__*/_react.default.createElement("input", {
      placeholder: input.placeholder,
      tabIndex: -1,
      type: "text"
    })) : input instanceof TimeInput ? /*#__PURE__*/_react.default.createElement("div", {
      key: index
    }, /*#__PURE__*/_react.default.createElement("input", {
      placeholder: input.placeholder,
      tabIndex: -1,
      type: "time"
    })) : input instanceof ToggleInput ? /*#__PURE__*/_react.default.createElement("div", {
      key: index
    }, input.title, /*#__PURE__*/_react.default.createElement("input", {
      defaultChecked: input.value === input.valueOn,
      tabIndex: -1,
      type: "checkbox"
    })) : false;
  }));
};

AdaptiveCardAttachment.propTypes = {
  content: _propTypes.default.any.isRequired
};
var _default = AdaptiveCardAttachment;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9hZGFwdGl2ZUNhcmRzL0F0dGFjaG1lbnRGb3JTY3JlZW5SZWFkZXIvQWRhcHRpdmVDYXJkQXR0YWNobWVudC5qcyJdLCJuYW1lcyI6WyJ1c2VMb2NhbGl6ZXIiLCJob29rcyIsIndhbGtBbGxJdGVtcyIsIm5vZGUiLCJmbiIsImdldEl0ZW1BdCIsImdldEl0ZW1Db3VudCIsImNvdW50IiwiaW5kZXgiLCJnZXRBY3Rpb25BdCIsImdldEFjdGlvbkNvdW50IiwiQWRhcHRpdmVDYXJkQ2hvaWNlU2V0SW5wdXQiLCJpbnB1dCIsImNob2ljZXMiLCJkZWZhdWx0VmFsdWUiLCJsYWJlbElkIiwiZGVmYXVsdENob2ljZSIsImZpbmQiLCJ2YWx1ZSIsInVuZGVmaW5lZCIsIm1hcCIsImNob2ljZSIsInRpdGxlIiwicHJvcFR5cGVzIiwiUHJvcFR5cGVzIiwic2hhcGUiLCJhcnJheU9mIiwic3RyaW5nIiwiYW55IiwiaXNSZXF1aXJlZCIsIkFkYXB0aXZlQ2FyZEF0dGFjaG1lbnQiLCJjb250ZW50IiwibG9jYWxpemUiLCJwYXJzZUFkYXB0aXZlQ2FyZEpTT04iLCJDaG9pY2VTZXRJbnB1dCIsIkRhdGVJbnB1dCIsIk51bWJlcklucHV0IiwiT3BlblVybEFjdGlvbiIsIlNob3dDYXJkQWN0aW9uIiwiU3VibWl0QWN0aW9uIiwiVGV4dElucHV0IiwiVGltZUlucHV0IiwiVG9nZ2xlSW5wdXQiLCJjYXJkIiwiaWdub3JlRXJyb3JzIiwiaW5wdXRzIiwicHVzaCIsImNhcmRMYWJlbCIsInNwZWFrIiwicGxhY2Vob2xkZXIiLCJ2YWx1ZU9uIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7O0FBRUE7O0FBQ0E7O0FBQ0E7O0FBRUE7O0FBQ0E7O0FBQ0E7O0FBUkE7O0FBQ0E7SUFTUUEsWSxHQUFpQkMsbUMsQ0FBakJELFksRUFFUjs7QUFDQSxTQUFTRSxZQUFULENBQXNCQyxJQUF0QixFQUE0QkMsRUFBNUIsRUFBZ0M7QUFDOUJBLEVBQUFBLEVBQUUs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RUFBQztBQUEzQixPQUNHSSxLQUFLLENBQUNVLEtBRFQsQ0FERixDQURFLEdBTUFWLEtBQUssWUFBWTRCLFNBQWpCLGdCQUNGO0FBQUssTUFBQSxHQUFHLEVBQUVoQztBQUFWLG9CQUNFO0FBQU8sTUFBQSxXQUFXLEVBQUVJLEtBQUssQ0FBQ3FDLFdBQTFCO0FBQXVDLE1BQUEsUUFBUSxFQUFFLENBQUMsQ0FBbEQ7QUFBcUQsTUFBQSxJQUFJLEVBQUM7QUFBMUQsTUFERixDQURFLEdBSUFyQyxLQUFLLFlBQVk2QixTQUFqQixnQkFDRjtBQUFLLE1BQUEsR0FBRyxFQUFFakM7QUFBVixvQkFDRTtBQUFPLE1BQUEsV0FBVyxFQUFFSSxLQUFLLENBQUNxQyxXQUExQjtBQUF1QyxNQUFBLFFBQVEsRUFBRSxDQUFDLENBQWxEO0FBQXFELE1BQUEsSUFBSSxFQUFDO0FBQTFELE1BREYsQ0FERSxHQUlBckMsS0FBSyxZQUFZOEIsV0FBakIsZ0JBQ0Y7QUFBSyxNQUFBLEdBQUcsRUFBRWxDO0FBQVYsT0FDR0ksS0FBSyxDQUFDVSxLQURULGVBRUU7QUFBTyxNQUFBLGNBQWMsRUFBRVYsS0FBSyxDQUFDTSxLQUFOLEtBQWdCTixLQUFLLENBQUNzQyxPQUE3QztBQUFzRCxNQUFBLFFBQVEsRUFBRSxDQUFDLENBQWpFO0FBQW9FLE1BQUEsSUFBSSxFQUFDO0FBQXpFLE1BRkYsQ0FERSxHQU1GLEtBL0JRO0FBQUEsR0FBWCxDQUZILENBREY7QUF1Q0QsQ0E3RkQ7O0FBK0ZBcEIsc0JBQXNCLENBQUNQLFNBQXZCLEdBQW1DO0FBQ2pDUSxFQUFBQSxPQUFPLEVBQUVQLG1CQUFVSSxHQUFWLENBQWNDO0FBRFUsQ0FBbkM7ZUFJZUMsc0IiLCJzb3VyY2VSb290IjoiYnVuZGxlOi8vLyIsInNvdXJjZXNDb250ZW50IjpbIi8qIGVzbGludC1kaXNhYmxlIHJlYWN0L25vLWFycmF5LWluZGV4LWtleSAqL1xuLyogZXNsaW50LWRpc2FibGUgcmVhY3QvZm9yYmlkLWRvbS1wcm9wcyAqL1xuaW1wb3J0IHsgaG9va3MgfSBmcm9tICdib3RmcmFtZXdvcmstd2ViY2hhdC1jb21wb25lbnQnO1xuaW1wb3J0IFByb3BUeXBlcyBmcm9tICdwcm9wLXR5cGVzJztcbmltcG9ydCBSZWFjdCwgeyB1c2VNZW1vIH0gZnJvbSAncmVhY3QnO1xuXG5pbXBvcnQgdXNlQWRhcHRpdmVDYXJkc1BhY2thZ2UgZnJvbSAnLi4vaG9va3MvdXNlQWRhcHRpdmVDYXJkc1BhY2thZ2UnO1xuaW1wb3J0IHVzZVBhcnNlQWRhcHRpdmVDYXJkSlNPTiBmcm9tICcuLi9ob29rcy9pbnRlcm5hbC91c2VQYXJzZUFkYXB0aXZlQ2FyZEpTT04nO1xuaW1wb3J0IHVzZVVuaXF1ZUlkIGZyb20gJy4uL2hvb2tzL2ludGVybmFsL3VzZVVuaXF1ZUlkJztcblxuY29uc3QgeyB1c2VMb2NhbGl6ZXIgfSA9IGhvb2tzO1xuXG4vLyBQZXJmb3JtIGEgZGVwdGgtZmlyc3Qgc2VhcmNoIG9mIHRoZSBBZGFwdGl2ZSBDYXJkIHRyZWUuXG5mdW5jdGlvbiB3YWxrQWxsSXRlbXMobm9kZSwgZm4pIHtcbiAgZm4obm9kZSk7XG5cbiAgaWYgKG5vZGUuZ2V0SXRlbUF0ICYmIG5vZGUuZ2V0SXRlbUNvdW50KSB7XG4gICAgZm9yIChsZXQgY291bnQgPSBub2RlLmdldEl0ZW1Db3VudCgpLCBpbmRleCA9IDA7IGluZGV4IDwgY291bnQ7IGluZGV4KyspIHtcbiAgICAgIHdhbGtBbGxJdGVtcyhub2RlLmdldEl0ZW1BdChpbmRleCksIGZuKTtcbiAgICB9XG4gIH1cblxuICBpZiAobm9kZS5nZXRBY3Rpb25BdCAmJiBub2RlLmdldEFjdGlvbkNvdW50KSB7XG4gICAgZm9yIChsZXQgY291bnQgPSBub2RlLmdldEFjdGlvbkNvdW50KCksIGluZGV4ID0gMDsgaW5kZXggPCBjb3VudDsgaW5kZXgrKykge1xuICAgICAgZm4obm9kZS5nZXRBY3Rpb25BdChpbmRleCkpO1xuICAgIH1cbiAgfVxufVxuXG5jb25zdCBBZGFwdGl2ZUNhcmRDaG9pY2VTZXRJbnB1dCA9ICh7IGlucHV0OiB7IGNob2ljZXMsIGRlZmF1bHRWYWx1ZSB9IH0pID0+IHtcbiAgY29uc3QgbGFiZWxJZCA9IHVzZVVuaXF1ZUlkKCd3ZWJjaGF0X19pZCcpO1xuICBjb25zdCBkZWZhdWx0Q2hvaWNlID0gY2hvaWNlcy5maW5kKCh7IHZhbHVlIH0pID0+IGRlZmF1bHRWYWx1ZSA9PT0gdmFsdWUgfHwgKCFkZWZhdWx0VmFsdWUgJiYgIXZhbHVlKSk7XG5cbiAgcmV0dXJuIChcbiAgICA8ZGl2PlxuICAgICAgPHNlbGVjdCBhcmlhLWxhYmVsbGVkYnk9e2RlZmF1bHRDaG9pY2UgPyBsYWJlbElkIDogdW5kZWZpbmVkfSBkZWZhdWx0VmFsdWU9e2RlZmF1bHRWYWx1ZX0gdGFiSW5kZXg9ey0xfT5cbiAgICAgICAge2Nob2ljZXMubWFwKGNob2ljZSA9PiAoXG4gICAgICAgICAgPG9wdGlvbiBpZD17Y2hvaWNlID09PSBkZWZhdWx0Q2hvaWNlID8gbGFiZWxJZCA6IHVuZGVmaW5lZH0ga2V5PXtjaG9pY2UudmFsdWV9IHZhbHVlPXtjaG9pY2UudmFsdWV9PlxuICAgICAgICAgICAge2Nob2ljZS50aXRsZX1cbiAgICAgICAgICA8L29wdGlvbj5cbiAgICAgICAgKSl9XG4gICAgICA8L3NlbGVjdD5cbiAgICA8L2Rpdj5cbiAgKTtcbn07XG5cbkFkYXB0aXZlQ2FyZENob2ljZVNldElucHV0LnByb3BUeXBlcyA9IHtcbiAgaW5wdXQ6IFByb3BUeXBlcy5zaGFwZSh7XG4gICAgY2hvaWNlczogUHJvcFR5cGVzLmFycmF5T2YoXG4gICAgICBQcm9wVHlwZXMuc2hhcGUoe1xuICAgICAgICB0aXRsZTogUHJvcFR5cGVzLnN0cmluZyxcbiAgICAgICAgdmFsdWU6IFByb3BUeXBlcy5hbnlcbiAgICAgIH0pXG4gICAgKSxcbiAgICBkZWZhdWx0VmFsdWU6IFByb3BUeXBlcy5hbnksXG4gICAgdmFsdWU6IFByb3BUeXBlcy5hbnlcbiAgfSkuaXNSZXF1aXJlZFxufTtcblxuY29uc3QgQWRhcHRpdmVDYXJkQXR0YWNobWVudCA9ICh7IGNvbnRlbnQgfSkgPT4ge1xuICBjb25zdCBsYWJlbElkID0gdXNlVW5pcXVlSWQoJ3dlYmNoYXRfX2lkJyk7XG4gIGNvbnN0IGxvY2FsaXplID0gdXNlTG9jYWxpemVyKCk7XG4gIGNvbnN0IHBhcnNlQWRhcHRpdmVDYXJkSlNPTiA9IHVzZVBhcnNlQWRhcHRpdmVDYXJkSlNPTigpO1xuICBjb25zdCBbXG4gICAge1xuICAgICAgQ2hvaWNlU2V0SW5wdXQsXG4gICAgICBEYXRlSW5wdXQsXG4gICAgICBOdW1iZXJJbnB1dCxcbiAgICAgIE9wZW5VcmxBY3Rpb24sXG4gICAgICBTaG93Q2FyZEFjdGlvbixcbiAgICAgIFN1Ym1pdEFjdGlvbixcbiAgICAgIFRleHRJbnB1dCxcbiAgICAgIFRpbWVJbnB1dCxcbiAgICAgIFRvZ2dsZUlucHV0XG4gICAgfVxuICBdID0gdXNlQWRhcHRpdmVDYXJkc1BhY2thZ2UoKTtcblxuICBjb25zdCBjYXJkID0gdXNlTWVtbygoKSA9PiBwYXJzZUFkYXB0aXZlQ2FyZEpTT04oY29udGVudCwgeyBpZ25vcmVFcnJvcnM6IHRydWUgfSksIFtjb250ZW50LCBwYXJzZUFkYXB0aXZlQ2FyZEpTT05dKTtcbiAgY29uc3QgaW5wdXRzID0gdXNlTWVtbygoKSA9PiB7XG4gICAgY29uc3QgaW5wdXRzID0gW107XG5cbiAgICB3YWxrQWxsSXRlbXMoY2FyZCwgbm9kZSA9PiB7XG4gICAgICBpZiAoXG4gICAgICAgIG5vZGUgaW5zdGFuY2VvZiBDaG9pY2VTZXRJbnB1dCB8fFxuICAgICAgICBub2RlIGluc3RhbmNlb2YgRGF0ZUlucHV0IHx8XG4gICAgICAgIG5vZGUgaW5zdGFuY2VvZiBOdW1iZXJJbnB1dCB8fFxuICAgICAgICBub2RlIGluc3RhbmNlb2YgT3BlblVybEFjdGlvbiB8fFxuICAgICAgICBub2RlIGluc3RhbmNlb2YgU2hvd0NhcmRBY3Rpb24gfHxcbiAgICAgICAgbm9kZSBpbnN0YW5jZW9mIFN1Ym1pdEFjdGlvbiB8fFxuICAgICAgICBub2RlIGluc3RhbmNlb2YgVGV4dElucHV0IHx8XG4gICAgICAgIG5vZGUgaW5zdGFuY2VvZiBUaW1lSW5wdXQgfHxcbiAgICAgICAgbm9kZSBpbnN0YW5jZW9mIFRvZ2dsZUlucHV0XG4gICAgICApIHtcbiAgICAgICAgaW5wdXRzLnB1c2gobm9kZSk7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICByZXR1cm4gaW5wdXRzO1xuICB9LCBbXG4gICAgY2FyZCxcbiAgICBDaG9pY2VTZXRJbnB1dCxcbiAgICBEYXRlSW5wdXQsXG4gICAgTnVtYmVySW5wdXQsXG4gICAgT3BlblVybEFjdGlvbixcbiAgICBTaG93Q2FyZEFjdGlvbixcbiAgICBTdWJtaXRBY3Rpb24sXG4gICAgVGV4dElucHV0LFxuICAgIFRpbWVJbnB1dCxcbiAgICBUb2dnbGVJbnB1dFxuICBdKTtcblxuICBjb25zdCBjYXJkTGFiZWwgPSBsb2NhbGl6ZSgnQVRUQUNITUVOVF9DQVJEJywgY2FyZC5zcGVhayB8fCAnJywgJycsICcnKTtcblxuICByZXR1cm4gKFxuICAgIDxhcnRpY2xlIGFyaWEtbGFiZWxsZWRieT17bGFiZWxJZH0+XG4gICAgICA8ZGl2IGlkPXtsYWJlbElkfT57Y2FyZExhYmVsfTwvZGl2PlxuICAgICAge2lucHV0cy5tYXAoKGlucHV0LCBpbmRleCkgPT5cbiAgICAgICAgaW5wdXQgaW5zdGFuY2VvZiBDaG9pY2VTZXRJbnB1dCA/IChcbiAgICAgICAgICA8QWRhcHRpdmVDYXJkQ2hvaWNlU2V0SW5wdXQgaW5wdXQ9e2lucHV0fSBrZXk9e2luZGV4fSAvPlxuICAgICAgICApIDogaW5wdXQgaW5zdGFuY2VvZiBEYXRlSW5wdXQgPyAoXG4gICAgICAgICAgPGRpdiBrZXk9e2luZGV4fT5cbiAgICAgICAgICAgIDxpbnB1dCBwbGFjZWhvbGRlcj17aW5wdXQucGxhY2Vob2xkZXJ9IHRhYkluZGV4PXstMX0gdHlwZT1cImRhdGVcIiAvPlxuICAgICAgICAgIDwvZGl2PlxuICAgICAgICApIDogaW5wdXQgaW5zdGFuY2VvZiBOdW1iZXJJbnB1dCA/IChcbiAgICAgICAgICA8ZGl2IGtleT17aW5kZXh9PlxuICAgICAgICAgICAgPGlucHV0IHBsYWNlaG9sZGVyPXtpbnB1dC5wbGFjZWhvbGRlcn0gdGFiSW5kZXg9ey0xfSB0eXBlPVwibnVtYmVyXCIgLz5cbiAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgKSA6IGlucHV0IGluc3RhbmNlb2YgT3BlblVybEFjdGlvbiB8fCBpbnB1dCBpbnN0YW5jZW9mIFNob3dDYXJkQWN0aW9uIHx8IGlucHV0IGluc3RhbmNlb2YgU3VibWl0QWN0aW9uID8gKFxuICAgICAgICAgIDxkaXYga2V5PXtpbmRleH0+XG4gICAgICAgICAgICA8YnV0dG9uIHRhYkluZGV4PXstMX0gdHlwZT1cImJ1dHRvblwiPlxuICAgICAgICAgICAgICB7aW5wdXQudGl0bGV9XG4gICAgICAgICAgICA8L2J1dHRvbj5cbiAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgKSA6IGlucHV0IGluc3RhbmNlb2YgVGV4dElucHV0ID8gKFxuICAgICAgICAgIDxkaXYga2V5PXtpbmRleH0+XG4gICAgICAgICAgICA8aW5wdXQgcGxhY2Vob2xkZXI9e2lucHV0LnBsYWNlaG9sZGVyfSB0YWJJbmRleD17LTF9IHR5cGU9XCJ0ZXh0XCIgLz5cbiAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgKSA6IGlucHV0IGluc3RhbmNlb2YgVGltZUlucHV0ID8gKFxuICAgICAgICAgIDxkaXYga2V5PXtpbmRleH0+XG4gICAgICAgICAgICA8aW5wdXQgcGxhY2Vob2xkZXI9e2lucHV0LnBsYWNlaG9sZGVyfSB0YWJJbmRleD17LTF9IHR5cGU9XCJ0aW1lXCIgLz5cbiAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgKSA6IGlucHV0IGluc3RhbmNlb2YgVG9nZ2xlSW5wdXQgPyAoXG4gICAgICAgICAgPGRpdiBrZXk9e2luZGV4fT5cbiAgICAgICAgICAgIHtpbnB1dC50aXRsZX1cbiAgICAgICAgICAgIDxpbnB1dCBkZWZhdWx0Q2hlY2tlZD17aW5wdXQudmFsdWUgPT09IGlucHV0LnZhbHVlT259IHRhYkluZGV4PXstMX0gdHlwZT1cImNoZWNrYm94XCIgLz5cbiAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgKSA6IChcbiAgICAgICAgICBmYWxzZVxuICAgICAgICApXG4gICAgICApfVxuICAgIDwvYXJ0aWNsZT5cbiAgKTtcbn07XG5cbkFkYXB0aXZlQ2FyZEF0dGFjaG1lbnQucHJvcFR5cGVzID0ge1xuICBjb250ZW50OiBQcm9wVHlwZXMuYW55LmlzUmVxdWlyZWRcbn07XG5cbmV4cG9ydCBkZWZhdWx0IEFkYXB0aXZlQ2FyZEF0dGFjaG1lbnQ7XG4iXX0=