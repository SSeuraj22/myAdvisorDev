"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = render;

var _toConsumableArray2 = _interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray"));

var _slicedToArray2 = _interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));

var _markdownItForInline = _interopRequireDefault(require("markdown-it-for-inline"));

var _markdownIt = _interopRequireDefault(require("markdown-it"));

var _markdownItAttrsEs = _interopRequireDefault(require("markdown-it-attrs-es5"));

var _sanitizeHtml = _interopRequireDefault(require("sanitize-html"));

/* eslint no-magic-numbers: ["error", { "ignore": [0, 1, 2] }] */
var SANITIZE_HTML_OPTIONS = {
  allowedAttributes: {
    a: ['aria-label', 'href', 'name', 'rel', 'target', 'title'],
    img: ['alt', 'class', 'src']
  },
  allowedSchemes: ['data', 'http', 'https', 'ftp', 'mailto', 'sip', 'tel'],
  allowedTags: ['a', 'b', 'blockquote', 'br', 'caption', 'code', 'del', 'div', 'em', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'hr', 'i', 'img', 'ins', 'li', 'nl', 'ol', 'p', 'pre', 's', 'span', 'strike', 'strong', 'table', 'tbody', 'td', 'tfoot', 'th', 'thead', 'tr', 'ul']
}; // Put a transparent pixel instead of the "open in new window" icon, so developers can easily modify the icon in CSS.

var TRANSPARENT_GIF = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7'; // This is used for parsing Markdown for external links.

var internalMarkdownIt = new _markdownIt.default();

function render(markdown, _ref) {
  var markdownRespectCRLF = _ref.markdownRespectCRLF;

  var _ref2 = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : {},
      _ref2$externalLinkAlt = _ref2.externalLinkAlt,
      externalLinkAlt = _ref2$externalLinkAlt === void 0 ? '' : _ref2$externalLinkAlt;

  if (markdownRespectCRLF) {
    markdown = markdown.replace(/\n\r|\r\n/g, function (carriageReturn) {
      return carriageReturn === '\n\r' ? '\r\n' : '\n\r';
    });
  }

  var html = new _markdownIt.default({
    breaks: false,
    html: false,
    linkify: true,
    typographer: true,
    xhtmlOut: true
  }).use(_markdownItAttrsEs.default).use(_markdownItForInline.default, 'url_new_win', 'link_open', function (tokens, index) {
    var token = tokens[index];
    token.attrSet('rel', 'noopener noreferrer');
    token.attrSet('target', '_blank');
    var linkOpenToken = tokens.find(function (_ref3) {
      var type = _ref3.type;
      return type === 'link_open';
    });

    var _linkOpenToken$attrs$ = linkOpenToken.attrs.find(function (_ref4) {
      var _ref5 = (0, _slicedToArray2.default)(_ref4, 1),
          name = _ref5[0];

      return name === 'href';
    }),
        _linkOpenToken$attrs$2 = (0, _slicedToArray2.default)(_linkOpenToken$attrs$, 2),
        href = _linkOpenToken$attrs$2[1]; // Adds a new icon if the link is http: or https:.
    // Don't add if it's a phone number, etc.


    if (/^http[s\u017F]?:/i.test(href)) {
      externalLinkAlt && token.attrSet('title', externalLinkAlt);
      var iconTokens = internalMarkdownIt.parseInline("![".concat(externalLinkAlt, "](").concat(TRANSPARENT_GIF, ")"))[0].children;
      iconTokens[0].attrJoin('class', 'webchat__markdown__external-link-icon');
      tokens.splice.apply(tokens, [index + 2, 0].concat((0, _toConsumableArray2.default)(iconTokens)));
    }
  }).render(markdown);
  return (0, _sanitizeHtml.default)(html, SANITIZE_HTML_OPTIONS);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9yZW5kZXJNYXJrZG93bi5qcyJdLCJuYW1lcyI6WyJTQU5JVElaRV9IVE1MX09QVElPTlMiLCJhbGxvd2VkQXR0cmlidXRlcyIsImEiLCJpbWciLCJhbGxvd2VkU2NoZW1lcyIsImFsbG93ZWRUYWdzIiwiVFJBTlNQQVJFTlRfR0lGIiwiaW50ZXJuYWxNYXJrZG93bkl0IiwiTWFya2Rvd25JdCIsInJlbmRlciIsIm1hcmtkb3duIiwibWFya2Rvd25SZXNwZWN0Q1JMRiIsImV4dGVybmFsTGlua0FsdCIsInJlcGxhY2UiLCJjYXJyaWFnZVJldHVybiIsImh0bWwiLCJicmVha3MiLCJsaW5raWZ5IiwidHlwb2dyYXBoZXIiLCJ4aHRtbE91dCIsInVzZSIsIm1hcmtkb3duSXRBdHRycyIsIml0ZXJhdG9yIiwidG9rZW5zIiwiaW5kZXgiLCJ0b2tlbiIsImF0dHJTZXQiLCJsaW5rT3BlblRva2VuIiwiZmluZCIsInR5cGUiLCJhdHRycyIsIm5hbWUiLCJocmVmIiwidGVzdCIsImljb25Ub2tlbnMiLCJwYXJzZUlubGluZSIsImNoaWxkcmVuIiwiYXR0ckpvaW4iLCJzcGxpY2UiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7QUFFQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFMQTtBQU9BLElBQU1BLHFCQUFxQixHQUFHO0FBQzVCQyxFQUFBQSxpQkFBaUIsRUFBRTtBQUNqQkMsSUFBQUEsQ0FBQyxFQUFFLENBQUMsWUFBRCxFQUFlLE1BQWYsRUFBdUIsTUFBdkIsRUFBK0IsS0FBL0IsRUFBc0MsUUFBdEMsRUFBZ0QsT0FBaEQsQ0FEYztBQUVqQkMsSUFBQUEsR0FBRyxFQUFFLENBQUMsS0FBRCxFQUFRLE9BQVIsRUFBaUIsS0FBakI7QUFGWSxHQURTO0FBSzVCQyxFQUFBQSxjQUFjLEVBQUUsQ0FBQyxNQUFELEVBQVMsTUFBVCxFQUFpQixPQUFqQixFQUEwQixLQUExQixFQUFpQyxRQUFqQyxFQUEyQyxLQUEzQyxFQUFrRCxLQUFsRCxDQUxZO0FBTTVC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QUFFQWQsTUFBQUEsTUFBTSxDQUFDZSxNQUFQLE9BQUFmLE1BQU0sR0FBUUMsS0FBSyxHQUFHLENBQWhCLEVBQW1CLENBQW5CLDBDQUF5QlUsVUFBekIsR0FBTjtBQUNEO0FBQ0YsR0E1QlUsRUE2QlZ6QixNQTdCVSxDQTZCSEMsUUE3QkcsQ0FBYjtBQStCQSxTQUFPLDJCQUFhSyxJQUFiLEVBQW1CZixxQkFBbkIsQ0FBUDtBQUNEIiwic291cmNlUm9vdCI6ImJ1bmRsZTovLy8iLCJzb3VyY2VzQ29udGVudCI6WyIvKiBlc2xpbnQgbm8tbWFnaWMtbnVtYmVyczogW1wiZXJyb3JcIiwgeyBcImlnbm9yZVwiOiBbMCwgMSwgMl0gfV0gKi9cblxuaW1wb3J0IGl0ZXJhdG9yIGZyb20gJ21hcmtkb3duLWl0LWZvci1pbmxpbmUnO1xuaW1wb3J0IE1hcmtkb3duSXQgZnJvbSAnbWFya2Rvd24taXQnO1xuaW1wb3J0IG1hcmtkb3duSXRBdHRycyBmcm9tICdtYXJrZG93bi1pdC1hdHRycy1lczUnO1xuaW1wb3J0IHNhbml0aXplSFRNTCBmcm9tICdzYW5pdGl6ZS1odG1sJztcblxuY29uc3QgU0FOSVRJWkVfSFRNTF9PUFRJT05TID0ge1xuICBhbGxvd2VkQXR0cmlidXRlczoge1xuICAgIGE6IFsnYXJpYS1sYWJlbCcsICdocmVmJywgJ25hbWUnLCAncmVsJywgJ3RhcmdldCcsICd0aXRsZSddLFxuICAgIGltZzogWydhbHQnLCAnY2xhc3MnLCAnc3JjJ11cbiAgfSxcbiAgYWxsb3dlZFNjaGVtZXM6IFsnZGF0YScsICdodHRwJywgJ2h0dHBzJywgJ2Z0cCcsICdtYWlsdG8nLCAnc2lwJywgJ3RlbCddLFxuICBhbGxvd2VkVGFnczogW1xuICAgICdhJyxcbiAgICAnYicsXG4gICAgJ2Jsb2NrcXVvdGUnLFxuICAgICdicicsXG4gICAgJ2NhcHRpb24nLFxuICAgICdjb2RlJyxcbiAgICAnZGVsJyxcbiAgICAnZGl2JyxcbiAgICAnZW0nLFxuICAgICdoMScsXG4gICAgJ2gyJyxcbiAgICAnaDMnLFxuICAgICdoNCcsXG4gICAgJ2g1JyxcbiAgICAnaDYnLFxuICAgICdocicsXG4gICAgJ2knLFxuICAgICdpbWcnLFxuICAgICdpbnMnLFxuICAgICdsaScsXG4gICAgJ25sJyxcbiAgICAnb2wnLFxuICAgICdwJyxcbiAgICAncHJlJyxcbiAgICAncycsXG4gICAgJ3NwYW4nLFxuICAgICdzdHJpa2UnLFxuICAgICdzdHJvbmcnLFxuICAgICd0YWJsZScsXG4gICAgJ3Rib2R5JyxcbiAgICAndGQnLFxuICAgICd0Zm9vdCcsXG4gICAgJ3RoJyxcbiAgICAndGhlYWQnLFxuICAgICd0cicsXG4gICAgJ3VsJ1xuICBdXG59O1xuXG4vLyBQdXQgYSB0cmFuc3BhcmVudCBwaXhlbCBpbnN0ZWFkIG9mIHRoZSBcIm9wZW4gaW4gbmV3IHdpbmRvd1wiIGljb24sIHNvIGRldmVsb3BlcnMgY2FuIGVhc2lseSBtb2RpZnkgdGhlIGljb24gaW4gQ1NTLlxuY29uc3QgVFJBTlNQQVJFTlRfR0lGID0gJ2RhdGE6aW1hZ2UvZ2lmO2Jhc2U2NCxSMGxHT0RsaEFRQUJBSUFBQUFBQUFQLy8veUg1QkFFQUFBQUFMQUFBQUFBQkFBRUFBQUlCUkFBNyc7XG5cbi8vIFRoaXMgaXMgdXNlZCBmb3IgcGFyc2luZyBNYXJrZG93biBmb3IgZXh0ZXJuYWwgbGlua3MuXG5jb25zdCBpbnRlcm5hbE1hcmtkb3duSXQgPSBuZXcgTWFya2Rvd25JdCgpO1xuXG5leHBvcnQgZGVmYXVsdCBmdW5jdGlvbiByZW5kZXIobWFya2Rvd24sIHsgbWFya2Rvd25SZXNwZWN0Q1JMRiB9LCB7IGV4dGVybmFsTGlua0FsdCA9ICcnIH0gPSB7fSkge1xuICBpZiAobWFya2Rvd25SZXNwZWN0Q1JMRikge1xuICAgIG1hcmtkb3duID0gbWFya2Rvd24ucmVwbGFjZSgvXFxuXFxyfFxcclxcbi9ndSwgY2FycmlhZ2VSZXR1cm4gPT4gKGNhcnJpYWdlUmV0dXJuID09PSAnXFxuXFxyJyA/ICdcXHJcXG4nIDogJ1xcblxccicpKTtcbiAgfVxuXG4gIGNvbnN0IGh0bWwgPSBuZXcgTWFya2Rvd25JdCh7XG4gICAgYnJlYWtzOiBmYWxzZSxcbiAgICBodG1sOiBmYWxzZSxcbiAgICBsaW5raWZ5OiB0cnVlLFxuICAgIHR5cG9ncmFwaGVyOiB0cnVlLFxuICAgIHhodG1sT3V0OiB0cnVlXG4gIH0pXG4gICAgLnVzZShtYXJrZG93bkl0QXR0cnMpXG4gICAgLnVzZShpdGVyYXRvciwgJ3VybF9uZXdfd2luJywgJ2xpbmtfb3BlbicsICh0b2tlbnMsIGluZGV4KSA9PiB7XG4gICAgICBjb25zdCB0b2tlbiA9IHRva2Vuc1tpbmRleF07XG5cbiAgICAgIHRva2VuLmF0dHJTZXQoJ3JlbCcsICdub29wZW5lciBub3JlZmVycmVyJyk7XG4gICAgICB0b2tlbi5hdHRyU2V0KCd0YXJnZXQnLCAnX2JsYW5rJyk7XG5cbiAgICAgIGNvbnN0IGxpbmtPcGVuVG9rZW4gPSB0b2tlbnMuZmluZCgoeyB0eXBlIH0pID0+IHR5cGUgPT09ICdsaW5rX29wZW4nKTtcbiAgICAgIGNvbnN0IFssIGhyZWZdID0gbGlua09wZW5Ub2tlbi5hdHRycy5maW5kKChbbmFtZV0pID0+IG5hbWUgPT09ICdocmVmJyk7XG5cbiAgICAgIC8vIEFkZHMgYSBuZXcgaWNvbiBpZiB0aGUgbGluayBpcyBodHRwOiBvciBodHRwczouXG4gICAgICAvLyBEb24ndCBhZGQgaWYgaXQncyBhIHBob25lIG51bWJlciwgZXRjLlxuICAgICAgaWYgKC9eaHR0cHM/Oi9pdS50ZXN0KGhyZWYpKSB7XG4gICAgICAgIGV4dGVybmFsTGlua0FsdCAmJiB0b2tlbi5hdHRyU2V0KCd0aXRsZScsIGV4dGVybmFsTGlua0FsdCk7XG5cbiAgICAgICAgY29uc3QgaWNvblRva2VucyA9IGludGVybmFsTWFya2Rvd25JdC5wYXJzZUlubGluZShgIVske2V4dGVybmFsTGlua0FsdH1dKCR7VFJBTlNQQVJFTlRfR0lGfSlgKVswXS5jaGlsZHJlbjtcblxuICAgICAgICBpY29uVG9rZW5zWzBdLmF0dHJKb2luKCdjbGFzcycsICd3ZWJjaGF0X19tYXJrZG93bl9fZXh0ZXJuYWwtbGluay1pY29uJyk7XG5cbiAgICAgICAgdG9rZW5zLnNwbGljZShpbmRleCArIDIsIDAsIC4uLmljb25Ub2tlbnMpO1xuICAgICAgfVxuICAgIH0pXG4gICAgLnJlbmRlcihtYXJrZG93bik7XG5cbiAgcmV0dXJuIHNhbml0aXplSFRNTChodG1sLCBTQU5JVElaRV9IVE1MX09QVElPTlMpO1xufVxuIl19