"use strict";

var _regeneratorRuntime2 = require("@babel/runtime/regenerator");

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = postActivitySaga;

var _regenerator = _interopRequireDefault(require("@babel/runtime/regenerator"));

var _toConsumableArray2 = _interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray"));

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _effects = require("redux-saga/effects");

var _observeOnce = _interopRequireDefault(require("./effects/observeOnce"));

var _whileConnected = _interopRequireDefault(require("./effects/whileConnected"));

var _clockSkewAdjustment = _interopRequireDefault(require("../selectors/clockSkewAdjustment"));

var _combineSelectors = _interopRequireDefault(require("../selectors/combineSelectors"));

var _language = _interopRequireDefault(require("../selectors/language"));

var _sendTimeout = _interopRequireDefault(require("../selectors/sendTimeout"));

var _deleteKey = _interopRequireDefault(require("../utils/deleteKey"));

var _sleep = _interopRequireDefault(require("../utils/sleep"));

var _uniqueID = _interopRequireDefault(require("../utils/uniqueID"));

var _postActivity = require("../actions/postActivity");

var _incomingActivity = require("../actions/incomingActivity");

var _marked = /*#__PURE__*/_regeneratorRuntime2.mark(postActivity),
    _marked2 = /*#__PURE__*/_regeneratorRuntime2.mark(postActivitySaga);

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { (0, _defineProperty2["default"])(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

function getTimestamp() {
  var clockSkewAdjustment = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : 0;
  return new Date(Date.now() + clockSkewAdjustment).toISOString();
}

function postActivity(directLine, userID, username, numActivitiesPosted, _ref) {
  var method, activity, _yield$select, clockSkewAdjustment, locale, _activity, attachments, clientActivityID, meta, echoBackCall, sendTimeout, _yield$race, echoBack;

  return _regenerator["default"].wrap(function postActivity$(_context2) {
    while (1) {
      switch (_context2.prev = _context2.next) {
        case 0:
          method = _ref.meta.method, activity = _ref.payload.activity;
          _context2.next = 3;
          return (0, _effects.select)((0, _combineSelectors["default"])({
            clockSkewAdjustment: _clockSkewAdjustment["default"],
            locale: _language["default"]
          }));

        case 3:
          _yield$select = _context2.sent;
          clockSkewAdjustment = _yield$select.clockSkewAdjustment;
          locale = _yield$select.locale;
          _activity = activity, attachments = _activity.attachments;
          clientActivityID = (0, _uniqueID["default"])();
          activity = _objectSpread(_objectSpread({}, (0, _deleteKey["default"])(activity, 'id')), {}, {
            attachments: attachments && attachments.map(function (_ref2) {
              var contentType = _ref2.contentType,
                  contentUrl = _ref2.contentUrl,
                  name = _ref2.name,
                  thumbnailUrl = _ref2.thumbnailUrl;
              return {
                contentType: contentType,
                contentUrl: contentUrl,
                name: name,
                thumbnailUrl: thumbnailUrl
              };
            }),
            channelData: _objectSpread(_objectSpread({}, (0, _deleteKey["default"])(activity.channelData, 'state')), {}, {
              clientActivityID: clientActivityID,
              // This is unskewed local timestamp for estimating clock skew.
              clientTimestamp: getTimestamp()
            }),
            channelId: 'webchat',
            from: {
              id: userID,
              name: username,
              role: 'user'
            },
            locale: locale,
            // This timestamp will be replaced by Direct Line Channel in echoback.
            // We are temporarily adding this timestamp for sorting.
            timestamp: getTimestamp(clockSkewAdjustment)
          });

          if (!numActivitiesPosted) {
            activity.entities = [].concat((0, _toConsumableArray2["default"])(activity.entities || []), [{
              // TODO: [P4] Currently in v3, we send the capabilities although the client might not actually have them
              //       We need to understand why we need to send these, and only send capabilities the client have
              requiresBotState: true,
              supportsListening: true,
              supportsTts: true,
              type: 'ClientCapabilities'
            }]);
          }

          meta = {
            clientActivityID: clientActivityID,
            method: method
          };
          _context2.next = 13;
          return (0, _effects.put)({
            type: _postActivity.POST_ACTIVITY_PENDING,
            meta: meta,
            payload: {
              activity: activity
            }
          });

        case 13:
          _context2.prev = 13;
          // Quirks: We might receive INCOMING_ACTIVITY before the postActivity call completed
          //         So, we setup expectation first, then postActivity afterward
          echoBackCall = (0, _effects.call)( /*#__PURE__*/_regenerator["default"].mark(function _callee() {
            var _yield$take, _activity2, _activity2$channelDat, channelData, id;

            return _regenerator["default"].wrap(function _callee$(_context) {
              while (1) {
                switch (_context.prev = _context.next) {
                  case 0:
                    _context.next = 2;
                    return (0, _effects.take)(_incomingActivity.INCOMING_ACTIVITY);

                  case 2:
                    _yield$take = _context.sent;
                    _activity2 = _yield$take.payload.activity;
                    _activity2$channelDat = _activity2.channelData, channelData = _activity2$channelDat === void 0 ? {} : _activity2$channelDat, id = _activity2.id;

                    if (!(channelData.clientActivityID === clientActivityID && id)) {
                      _context.next = 7;
                      break;
                    }

                    return _context.abrupt("return", _activity2);

                  case 7:
                    _context.next = 0;
                    break;

                  case 9:
                  case "end":
                    return _context.stop();
                }
              }
            }, _callee);
          })); // Timeout could be due to either:
          // - Post activity call may take too long time to complete
          //   - Direct Line service only respond on HTTP after bot respond to Direct Line
          // - Activity may take too long time to echo back

          _context2.next = 17;
          return (0, _effects.select)(_sendTimeout["default"]);

        case 17:
          sendTimeout = _context2.sent;
          _context2.next = 20;
          return (0, _effects.race)({
            send: (0, _effects.all)({
              echoBack: echoBackCall,
              postActivity: (0, _observeOnce["default"])(directLine.postActivity(activity))
            }),
            timeout: (0, _effects.call)(function () {
              return (0, _sleep["default"])(sendTimeout).then(function () {
                return Promise.reject(new Error('timeout'));
              });
            })
          });

        case 20:
          _yield$race = _context2.sent;
          echoBack = _yield$race.send.echoBack;
          _context2.next = 24;
          return (0, _effects.put)({
            type: _postActivity.POST_ACTIVITY_FULFILLED,
            meta: meta,
            payload: {
              activity: echoBack
            }
          });

        case 24:
          _context2.next = 31;
          break;

        case 26:
          _context2.prev = 26;
          _context2.t0 = _context2["catch"](13);
          console.error('botframework-webchat: Failed to post activity to chat adapter.', _context2.t0);
          _context2.next = 31;
          return (0, _effects.put)({
            type: _postActivity.POST_ACTIVITY_REJECTED,
            error: true,
            meta: meta,
            payload: _context2.t0
          });

        case 31:
          _context2.prev = 31;
          _context2.next = 34;
          return (0, _effects.cancelled)();

        case 34:
          if (!_context2.sent) {
            _context2.next = 37;
            break;
          }

          _context2.next = 37;
          return (0, _effects.put)({
            type: _postActivity.POST_ACTIVITY_REJECTED,
            error: true,
            meta: meta,
            payload: new Error('cancelled')
          });

        case 37:
          return _context2.finish(31);

        case 38:
        case "end":
          return _context2.stop();
      }
    }
  }, _marked, null, [[13, 26, 31, 38]]);
}

function postActivitySaga() {
  return _regenerator["default"].wrap(function postActivitySaga$(_context5) {
    while (1) {
      switch (_context5.prev = _context5.next) {
        case 0:
          _context5.next = 2;
          return (0, _whileConnected["default"])( /*#__PURE__*/_regenerator["default"].mark(function postActivityWhileConnected(_ref3) {
            var directLine, userID, username, numActivitiesPosted;
            return _regenerator["default"].wrap(function postActivityWhileConnected$(_context4) {
              while (1) {
                switch (_context4.prev = _context4.next) {
                  case 0:
                    directLine = _ref3.directLine, userID = _ref3.userID, username = _ref3.username;
                    numActivitiesPosted = 0;
                    _context4.next = 4;
                    return (0, _effects.takeEvery)(_postActivity.POST_ACTIVITY, /*#__PURE__*/_regenerator["default"].mark(function postActivityWrapper(action) {
                      return _regenerator["default"].wrap(function postActivityWrapper$(_context3) {
                        while (1) {
                          switch (_context3.prev = _context3.next) {
                            case 0:
                              return _context3.delegateYield(postActivity(directLine, userID, username, numActivitiesPosted++, action), "t0", 1);

                            case 1:
                            case "end":
                              return _context3.stop();
                          }
                        }
                      }, postActivityWrapper);
                    }));

                  case 4:
                  case "end":
                    return _context4.stop();
                }
              }
            }, postActivityWhileConnected);
          }));

        case 2:
        case "end":
          return _context5.stop();
      }
    }
  }, _marked2);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zYWdhcy9wb3N0QWN0aXZpdHlTYWdhLmpzIl0sIm5hbWVzIjpbInBvc3RBY3Rpdml0eSIsInBvc3RBY3Rpdml0eVNhZ2EiLCJnZXRUaW1lc3RhbXAiLCJjbG9ja1NrZXdBZGp1c3RtZW50IiwiRGF0ZSIsIm5vdyIsInRvSVNPU3RyaW5nIiwiZGlyZWN0TGluZSIsInVzZXJJRCIsInVzZXJuYW1lIiwibnVtQWN0aXZpdGllc1Bvc3RlZCIsIm1ldGhvZCIsIm1ldGEiLCJhY3Rpdml0eSIsInBheWxvYWQiLCJjbG9ja1NrZXdBZGp1c3RtZW50U2VsZWN0b3IiLCJsb2NhbGUiLCJsYW5ndWFnZVNlbGVjdG9yIiwiYXR0YWNobWVudHMiLCJjbGllbnRBY3Rpdml0eUlEIiwibWFwIiwiY29udGVudFR5cGUiLCJjb250ZW50VXJsIiwibmFtZSIsInRodW1ibmFpbFVybCIsImNoYW5uZWxEYXRhIiwiY2xpZW50VGltZXN0YW1wIiwiY2hhbm5lbElkIiwiZnJvbSIsImlkIiwicm9sZSIsInRpbWVzdGFtcCIsImVudGl0aWVzIiwicmVxdWlyZXNCb3RTdGF0ZSIsInN1cHBvcnRzTGlzdGVuaW5nIiwic3VwcG9ydHNUdHMiLCJ0eXBlIiwiUE9TVF9BQ1RJVklUWV9QRU5ESU5HIiwiZWNob0JhY2tDYWxsIiwiSU5DT01JTkdfQUNUSVZJVFkiLCJzZW5kVGltZW91dFNlbGVjdG9yIiwic2VuZFRpbWVvdXQiLCJzZW5kIiwiZWNob0JhY2siLCJ0aW1lb3V0IiwidGhlbiIsIlByb21pc2UiLCJyZWplY3QiLCJFcnJvciIsIlBPU1RfQUNUSVZJVFlfRlVMRklMTEVEIiwiY29uc29sZSIsImVycm9yIiwiUE9TVF9BQ1RJVklUWV9SRUpFQ1RFRCIsInBvc3RBY3Rpdml0eVdoaWxlQ29ubmVjdGVkIiwiUE9TVF9BQ1RJVklUWSIsInBvc3RBY3Rpdml0eVdyYXBwZXIiLCJhY3Rpb24iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUE7O0FBRUE7O0FB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LFNBQW1EQSxNQUFuRCxFQUEyREMsUUFBM0QsU0FBMkRBLFFBQTNEO0FBQ2ZDLG9CQUFBQSxtQkFEZSxHQUNPLENBRFA7QUFBQTtBQUduQiwyQkFBTSx3QkFBVTRDLDJCQUFWLDRDQUF5QixTQUFVQyxtQkFBVixDQUE4QkMsTUFBOUI7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUM3Qiw2REFBT3hELFlBQVksQ0FBQ08sVUFBRCxFQUFhQyxNQUFiLEVBQXFCQyxRQUFyQixFQUErQkMsbUJBQW1CLEVBQWxELEVBQXNEOEMsTUFBdEQsQ0FBbkI7O0FBRDZCO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQSx5QkFBVUQsbUJBQVY7QUFBQSxxQkFBekIsRUFBTjs7QUFIbUI7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBLGVBQVVGLDBCQUFWO0FBQUEsV0FBZixFQUFOOztBQURhO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBIiwic291cmNlUm9vdCI6ImNvcmU6Ly8vIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgYWxsLCBjYWxsLCBjYW5jZWxsZWQsIHB1dCwgcmFjZSwgc2VsZWN0LCB0YWtlLCB0YWtlRXZlcnkgfSBmcm9tICdyZWR1eC1zYWdhL2VmZmVjdHMnO1xuXG5pbXBvcnQgb2JzZXJ2ZU9uY2UgZnJvbSAnLi9lZmZlY3RzL29ic2VydmVPbmNlJztcbmltcG9ydCB3aGlsZUNvbm5lY3RlZCBmcm9tICcuL2VmZmVjdHMvd2hpbGVDb25uZWN0ZWQnO1xuXG5pbXBvcnQgY2xvY2tTa2V3QWRqdXN0bWVudFNlbGVjdG9yIGZyb20gJy4uL3NlbGVjdG9ycy9jbG9ja1NrZXdBZGp1c3RtZW50JztcbmltcG9ydCBjb21iaW5lU2VsZWN0b3JzIGZyb20gJy4uL3NlbGVjdG9ycy9jb21iaW5lU2VsZWN0b3JzJztcbmltcG9ydCBsYW5ndWFnZVNlbGVjdG9yIGZyb20gJy4uL3NlbGVjdG9ycy9sYW5ndWFnZSc7XG5pbXBvcnQgc2VuZFRpbWVvdXRTZWxlY3RvciBmcm9tICcuLi9zZWxlY3RvcnMvc2VuZFRpbWVvdXQnO1xuXG5pbXBvcnQgZGVsZXRlS2V5IGZyb20gJy4uL3V0aWxzL2RlbGV0ZUtleSc7XG5pbXBvcnQgc2xlZXAgZnJvbSAnLi4vdXRpbHMvc2xlZXAnO1xuaW1wb3J0IHVuaXF1ZUlEIGZyb20gJy4uL3V0aWxzL3VuaXF1ZUlEJztcblxuaW1wb3J0IHtcbiAgUE9TVF9BQ1RJVklUWSxcbiAgUE9TVF9BQ1RJVklUWV9GVUxGSUxMRUQsXG4gIFBPU1RfQUNUSVZJVFlfUEVORElORyxcbiAgUE9TVF9BQ1RJVklUWV9SRUpFQ1RFRFxufSBmcm9tICcuLi9hY3Rpb25zL3Bvc3RBY3Rpdml0eSc7XG5cbmltcG9ydCB7IElOQ09NSU5HX0FDVElWSVRZIH0gZnJvbSAnLi4vYWN0aW9ucy9pbmNvbWluZ0FjdGl2aXR5JztcblxuZnVuY3Rpb24gZ2V0VGltZXN0YW1wKGNsb2NrU2tld0FkanVzdG1lbnQgPSAwKSB7XG4gIHJldHVybiBuZXcgRGF0ZShEYXRlLm5vdygpICsgY2xvY2tTa2V3QWRqdXN0bWVudCkudG9JU09TdHJpbmcoKTtcbn1cblxuZnVuY3Rpb24qIHBvc3RBY3Rpdml0eShkaXJlY3RMaW5lLCB1c2VySUQsIHVzZXJuYW1lLCBudW1BY3Rpdml0aWVzUG9zdGVkLCB7IG1ldGE6IHsgbWV0aG9kIH0sIHBheWxvYWQ6IHsgYWN0aXZpdHkgfSB9KSB7XG4gIGNvbnN0IHsgY2xvY2tTa2V3QWRqdXN0bWVudCwgbG9jYWxlIH0gPSB5aWVsZCBzZWxlY3QoXG4gICAgY29tYmluZVNlbGVjdG9ycyh7IGNsb2NrU2tld0FkanVzdG1lbnQ6IGNsb2NrU2tld0FkanVzdG1lbnRTZWxlY3RvciwgbG9jYWxlOiBsYW5ndWFnZVNlbGVjdG9yIH0pXG4gICk7XG4gIGNvbnN0IHsgYXR0YWNobWVudHMgfSA9IGFjdGl2aXR5O1xuICBjb25zdCBjbGllbnRBY3Rpdml0eUlEID0gdW5pcXVlSUQoKTtcblxuICBhY3Rpdml0eSA9IHtcbiAgICAuLi5kZWxldGVLZXkoYWN0aXZpdHksICdpZCcpLFxuICAgIGF0dGFjaG1lbnRzOlxuICAgICAgYXR0YWNobWVudHMgJiZcbiAgICAgIGF0dGFjaG1lbnRzLm1hcCgoeyBjb250ZW50VHlwZSwgY29udGVudFVybCwgbmFtZSwgdGh1bWJuYWlsVXJsIH0pID0+ICh7XG4gICAgICAgIGNvbnRlbnRUeXBlLFxuICAgICAgICBjb250ZW50VXJsLFxuICAgICAgICBuYW1lLFxuICAgICAgICB0aHVtYm5haWxVcmxcbiAgICAgIH0pKSxcbiAgICBjaGFubmVsRGF0YToge1xuICAgICAgLi4uZGVsZXRlS2V5KGFjdGl2aXR5LmNoYW5uZWxEYXRhLCAnc3RhdGUnKSxcbiAgICAgIGNsaWVudEFjdGl2aXR5SUQsXG4gICAgICAvLyBUaGlzIGlzIHVuc2tld2VkIGxvY2FsIHRpbWVzdGFtcCBmb3IgZXN0aW1hdGluZyBjbG9jayBza2V3LlxuICAgICAgY2xpZW50VGltZXN0YW1wOiBnZXRUaW1lc3RhbXAoKVxuICAgIH0sXG4gICAgY2hhbm5lbElkOiAnd2ViY2hhdCcsXG4gICAgZnJvbToge1xuICAgICAgaWQ6IHVzZXJJRCxcbiAgICAgIG5hbWU6IHVzZXJuYW1lLFxuICAgICAgcm9sZTogJ3VzZXInXG4gICAgfSxcbiAgICBsb2NhbGUsXG4gICAgLy8gVGhpcyB0aW1lc3RhbXAgd2lsbCBiZSByZXBsYWNlZCBieSBEaXJlY3QgTGluZSBDaGFubmVsIGluIGVjaG9iYWNrLlxuICAgIC8vIFdlIGFyZSB0ZW1wb3JhcmlseSBhZGRpbmcgdGhpcyB0aW1lc3RhbXAgZm9yIHNvcnRpbmcuXG4gICAgdGltZXN0YW1wOiBnZXRUaW1lc3RhbXAoY2xvY2tTa2V3QWRqdXN0bWVudClcbiAgfTtcblxuICBpZiAoIW51bUFjdGl2aXRpZXNQb3N0ZWQpIHtcbiAgICBhY3Rpdml0eS5lbnRpdGllcyA9IFtcbiAgICAgIC4uLihhY3Rpdml0eS5lbnRpdGllcyB8fCBbXSksXG4gICAgICB7XG4gICAgICAgIC8vIFRPRE86IFtQNF0gQ3VycmVudGx5IGluIHYzLCB3ZSBzZW5kIHRoZSBjYXBhYmlsaXRpZXMgYWx0aG91Z2ggdGhlIGNsaWVudCBtaWdodCBub3QgYWN0dWFsbHkgaGF2ZSB0aGVtXG4gICAgICAgIC8vICAgICAgIFdlIG5lZWQgdG8gdW5kZXJzdGFuZCB3aHkgd2UgbmVlZCB0byBzZW5kIHRoZXNlLCBhbmQgb25seSBzZW5kIGNhcGFiaWxpdGllcyB0aGUgY2xpZW50IGhhdmVcbiAgICAgICAgcmVxdWlyZXNCb3RTdGF0ZTogdHJ1ZSxcbiAgICAgICAgc3VwcG9ydHNMaXN0ZW5pbmc6IHRydWUsXG4gICAgICAgIHN1cHBvcnRzVHRzOiB0cnVlLFxuICAgICAgICB0eXBlOiAnQ2xpZW50Q2FwYWJpbGl0aWVzJ1xuICAgICAgfVxuICAgIF07XG4gIH1cblxuICBjb25zdCBtZXRhID0geyBjbGllbnRBY3Rpdml0eUlELCBtZXRob2QgfTtcblxuICB5aWVsZCBwdXQoeyB0eXBlOiBQT1NUX0FDVElWSVRZX1BFTkRJTkcsIG1ldGEsIHBheWxvYWQ6IHsgYWN0aXZpdHkgfSB9KTtcblxuICB0cnkge1xuICAgIC8vIFF1aXJrczogV2UgbWlnaHQgcmVjZWl2ZSBJTkNPTUlOR19BQ1RJVklUWSBiZWZvcmUgdGhlIHBvc3RBY3Rpdml0eSBjYWxsIGNvbXBsZXRlZFxuICAgIC8vICAgICAgICAgU28sIHdlIHNldHVwIGV4cGVjdGF0aW9uIGZpcnN0LCB0aGVuIHBvc3RBY3Rpdml0eSBhZnRlcndhcmRcblxuICAgIGNvbnN0IGVjaG9CYWNrQ2FsbCA9IGNhbGwoZnVuY3Rpb24qICgpIHtcbiAgICAgIGZvciAoOzspIHtcbiAgICAgICAgY29uc3Qge1xuICAgICAgICAgIHBheWxvYWQ6IHsgYWN0aXZpdHkgfVxuICAgICAgICB9ID0geWllbGQgdGFrZShJTkNPTUlOR19BQ1RJVklUWSk7XG4gICAgICAgIGNvbnN0IHsgY2hhbm5lbERhdGEgPSB7fSwgaWQgfSA9IGFjdGl2aXR5O1xuXG4gICAgICAgIGlmIChjaGFubmVsRGF0YS5jbGllbnRBY3Rpdml0eUlEID09PSBjbGllbnRBY3Rpdml0eUlEICYmIGlkKSB7XG4gICAgICAgICAgcmV0dXJuIGFjdGl2aXR5O1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICAvLyBUaW1lb3V0IGNvdWxkIGJlIGR1ZSB0byBlaXRoZXI6XG4gICAgLy8gLSBQb3N0IGFjdGl2aXR5IGNhbGwgbWF5IHRha2UgdG9vIGxvbmcgdGltZSB0byBjb21wbGV0ZVxuICAgIC8vICAgLSBEaXJlY3QgTGluZSBzZXJ2aWNlIG9ubHkgcmVzcG9uZCBvbiBIVFRQIGFmdGVyIGJvdCByZXNwb25kIHRvIERpcmVjdCBMaW5lXG4gICAgLy8gLSBBY3Rpdml0eSBtYXkgdGFrZSB0b28gbG9uZyB0aW1lIHRvIGVjaG8gYmFja1xuXG4gICAgY29uc3Qgc2VuZFRpbWVvdXQgPSB5aWVsZCBzZWxlY3Qoc2VuZFRpbWVvdXRTZWxlY3Rvcik7XG5cbiAgICBjb25zdCB7XG4gICAgICBzZW5kOiB7IGVjaG9CYWNrIH1cbiAgICB9ID0geWllbGQgcmFjZSh7XG4gICAgICBzZW5kOiBhbGwoe1xuICAgICAgICBlY2hvQmFjazogZWNob0JhY2tDYWxsLFxuICAgICAgICBwb3N0QWN0aXZpdHk6IG9ic2VydmVPbmNlKGRpcmVjdExpbmUucG9zdEFjdGl2aXR5KGFjdGl2aXR5KSlcbiAgICAgIH0pLFxuICAgICAgdGltZW91dDogY2FsbCgoKSA9PiBzbGVlcChzZW5kVGltZW91dCkudGhlbigoKSA9PiBQcm9taXNlLnJlamVjdChuZXcgRXJyb3IoJ3RpbWVvdXQnKSkpKVxuICAgIH0pO1xuXG4gICAgeWllbGQgcHV0KHsgdHlwZTogUE9TVF9BQ1RJVklUWV9GVUxGSUxMRUQsIG1ldGEsIHBheWxvYWQ6IHsgYWN0aXZpdHk6IGVjaG9CYWNrIH0gfSk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGNvbnNvbGUuZXJyb3IoJ2JvdGZyYW1ld29yay13ZWJjaGF0OiBGYWlsZWQgdG8gcG9zdCBhY3Rpdml0eSB0byBjaGF0IGFkYXB0ZXIuJywgZXJyKTtcblxuICAgIHlpZWxkIHB1dCh7IHR5cGU6IFBPU1RfQUNUSVZJVFlfUkVKRUNURUQsIGVycm9yOiB0cnVlLCBtZXRhLCBwYXlsb2FkOiBlcnIgfSk7XG4gIH0gZmluYWxseSB7XG4gICAgaWYgKHlpZWxkIGNhbmNlbGxlZCgpKSB7XG4gICAgICB5aWVsZCBwdXQoeyB0eXBlOiBQT1NUX0FDVElWSVRZX1JFSkVDVEVELCBlcnJvcjogdHJ1ZSwgbWV0YSwgcGF5bG9hZDogbmV3IEVycm9yKCdjYW5jZWxsZWQnKSB9KTtcbiAgICB9XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgZnVuY3Rpb24qIHBvc3RBY3Rpdml0eVNhZ2EoKSB7XG4gIHlpZWxkIHdoaWxlQ29ubmVjdGVkKGZ1bmN0aW9uKiBwb3N0QWN0aXZpdHlXaGlsZUNvbm5lY3RlZCh7IGRpcmVjdExpbmUsIHVzZXJJRCwgdXNlcm5hbWUgfSkge1xuICAgIGxldCBudW1BY3Rpdml0aWVzUG9zdGVkID0gMDtcblxuICAgIHlpZWxkIHRha2VFdmVyeShQT1NUX0FDVElWSVRZLCBmdW5jdGlvbiogcG9zdEFjdGl2aXR5V3JhcHBlcihhY3Rpb24pIHtcbiAgICAgIHlpZWxkKiBwb3N0QWN0aXZpdHkoZGlyZWN0TGluZSwgdXNlcklELCB1c2VybmFtZSwgbnVtQWN0aXZpdGllc1Bvc3RlZCsrLCBhY3Rpb24pO1xuICAgIH0pO1xuICB9KTtcbn1cbiJdfQ==